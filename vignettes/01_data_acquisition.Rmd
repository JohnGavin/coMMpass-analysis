---
title: "01. Data Acquisition & Status"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{01. Data Acquisition & Status}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#">"
)
library(targets)
library(dplyr)
library(ggplot2)
library(stringr)

key <- "TAR_PROJECT"
proj_dir <- Sys.getenv(key)
if (proj_dir != "" && dir.exists(file.path(proj_dir, "_targets"))) {
  tar_config_set(store = file.path(proj_dir, "_targets"))
}
```

## Overview

This report summarizes the initial data acquisition step for the MMRF CoMMpass study. We access Open Access RNA-seq data from the GDC S3 bucket (`s3://gdc-mmrf-commpass-phs000748-2-open/`).

## S3 Bucket Status

We query the S3 bucket to get a complete manifest of available files.

```{r manifest}
# Load the manifest from the targets pipeline
manifest_lines <- tar_read(s3_manifest)

# Parse the ls output
# Format: "2022-05-11 10:23:45 123456 filename"
manifest_df <- tibble(line = manifest_lines) %>%
  mutate(
    date = str_extract(line, "^\\d{4}-\\d{2}-\\d{2}"),
    time = str_extract(line, "\\d{2}:\\d{2}:\\d{2}"),
    size = as.numeric(str_extract(line, "(?<=\\s)\\d+(?=\\s)")),
    file = str_extract(line, "[^\\s]+$")
  ) %>%
  filter(!is.na(size))

cat("Total files in S3 bucket:", nrow(manifest_df), "\n")
cat("Total size:", format(sum(manifest_df$size, na.rm=TRUE), units="auto"), "\n")
```

### File Type Distribution

```{r plot_types, fig.width=8, fig.height=4}
manifest_df %>%
  mutate(extension = str_extract(file, "\\.[^.]+$")) %>%
  count(extension) %>%
  ggplot(aes(x = n, y = reorder(extension, n))) + 
  geom_col(fill = "steelblue") + 
  theme_minimal() + 
  labs(title = "File Types in CoMMpass S3 Bucket", x = "Count", y = "Extension")
```

## Downloaded Samples

We downloaded a small subset of RNA-seq files for initial testing.

```{r samples}
downloaded <- tar_read(rna_sample_files)
print(basename(downloaded))
```

## Clinical Data

Clinical metadata retrieved from GDC:

```{r clinical}
clinical <- tar_read(clinical_data)
# Fix duplicate column names
names(clinical) <- make.unique(names(clinical))
cat("Clinical records:", nrow(clinical), "\n")

# Display a subset of columns
cols_to_show <- c("project", "submitter_id", "gender", "vital_status")
# Ensure columns exist
cols_to_show <- intersect(cols_to_show, names(clinical))

knitr::kable(head(clinical[, cols_to_show, drop = FALSE]))
```

## Reproducibility

### Git Commit Info

```{r git-info, echo=FALSE}
if (requireNamespace("gert", quietly = TRUE)) {
  tryCatch({
    # We use the current directory assuming the vignette runs in project root
    # If pkgdown moves it, we might need Sys.getenv("TAR_PROJECT")
    repo_path <- "."
    if (Sys.getenv("TAR_PROJECT") != "") repo_path <- Sys.getenv("TAR_PROJECT")
    
    info <- gert::git_info(repo = repo_path)
    knitr::kable(data.frame(
      Item = c("Commit Hash", "Author", "Time", "Branch"),
      Value = c(info$commit, info$author, as.character(info$time), info$shorthand)
    ))
  }, error = function(e) {
    cat("Git info not available.")
  })
} else {
  cat("gert package not installed.")
}
```

### Session Info

```{r session-info}
sessionInfo()
```