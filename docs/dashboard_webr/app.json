[{"name":"app.R","content":"# Load required packages\nlibrary(shiny)\nlibrary(bslib)\nlibrary(plotly)\nlibrary(DT)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(survival)\n\n# ============================================================================\n# Data Generation Functions\n# ============================================================================\n\ngenerate_example_counts <- function(n_genes = 500, n_samples = 40) {\n  # Generate realistic RNA-seq counts\n  set.seed(123)\n  \n  gene_names <- paste0(\"GENE\", seq_len(n_genes))\n  sample_names <- paste0(\"SAMPLE\", seq_len(n_samples))\n  \n  # Simulate counts with overdispersion\n  counts <- matrix(\n    rnbinom(n_genes * n_samples, mu = 500, size = 2),\n    nrow = n_genes,\n    dimnames = list(gene_names, sample_names)\n  )\n  \n  # Add some differential expression for first 50 genes\n  group1_samples <- seq_len(n_samples / 2)\n  counts[1:50, group1_samples] <- counts[1:50, group1_samples] * 2\n  \n  return(counts)\n}\n\ngenerate_example_clinical <- function(n_samples = 40) {\n  set.seed(123)\n  \n  sample_names <- paste0(\"SAMPLE\", seq_len(n_samples))\n  \n  clinical <- data.frame(\n    sample = sample_names,\n    age = round(rnorm(n_samples, mean = 65, sd = 10)),\n    stage = sample(c(\"I\", \"II\", \"III\"), n_samples, replace = TRUE),\n    risk_group = sample(c(\"Standard\", \"High\"), n_samples, replace = TRUE),\n    response = sample(c(\"CR\", \"PR\", \"SD\", \"PD\"), n_samples, replace = TRUE),\n    os_time = round(rexp(n_samples, rate = 1/365) * 365),\n    os_status = rbinom(n_samples, 1, 0.4),\n    pfs_time = round(rexp(n_samples, rate = 1/250) * 250),\n    pfs_status = rbinom(n_samples, 1, 0.5),\n    stringsAsFactors = FALSE\n  )\n  \n  return(clinical)\n}\n\ngenerate_example_qc <- function(counts) {\n  data.frame(\n    sample = colnames(counts),\n    total_counts = colSums(counts),\n    detected_genes = colSums(counts > 0),\n    is_outlier = FALSE,\n    stringsAsFactors = FALSE\n  )\n}\n\ngenerate_example_de <- function(counts) {\n  n_genes <- nrow(counts)\n  gene_names <- rownames(counts)\n  \n  # Simulate DE results\n  list(\n    DESeq2 = data.frame(\n      gene = gene_names,\n      baseMean = rowMeans(counts),\n      log2FoldChange = c(rnorm(50, mean = 2, sd = 0.5), rnorm(n_genes - 50, mean = 0, sd = 0.3)),\n      lfcSE = runif(n_genes, 0.1, 0.3),\n      stat = rnorm(n_genes, 0, 2),\n      pvalue = c(runif(50, 0, 0.01), runif(n_genes - 50, 0, 1)),\n      padj = c(runif(50, 0, 0.05), runif(n_genes - 50, 0.05, 1)),\n      stringsAsFactors = FALSE\n    ),\n    edgeR = data.frame(\n      gene = gene_names,\n      logFC = c(rnorm(50, mean = 2, sd = 0.5), rnorm(n_genes - 50, mean = 0, sd = 0.3)),\n      logCPM = log2(rowMeans(counts) + 1),\n      PValue = c(runif(50, 0, 0.01), runif(n_genes - 50, 0, 1)),\n      FDR = c(runif(50, 0, 0.05), runif(n_genes - 50, 0.05, 1)),\n      stringsAsFactors = FALSE\n    ),\n    limma = data.frame(\n      gene = gene_names,\n      logFC = c(rnorm(50, mean = 2, sd = 0.5), rnorm(n_genes - 50, mean = 0, sd = 0.3)),\n      AveExpr = rowMeans(log2(counts + 1)),\n      t = rnorm(n_genes, 0, 2),\n      P.Value = c(runif(50, 0, 0.01), runif(n_genes - 50, 0, 1)),\n      adj.P.Val = c(runif(50, 0, 0.05), runif(n_genes - 50, 0.05, 1)),\n      B = rnorm(n_genes, 0, 2),\n      stringsAsFactors = FALSE\n    )\n  )\n}\n\ngenerate_example_pathways <- function() {\n  data.frame(\n    pathway = c(\n      \"HALLMARK_MYC_TARGETS_V1\", \"HALLMARK_E2F_TARGETS\",\n      \"HALLMARK_G2M_CHECKPOINT\", \"HALLMARK_APOPTOSIS\",\n      \"HALLMARK_UNFOLDED_PROTEIN_RESPONSE\", \"HALLMARK_INFLAMMATORY_RESPONSE\",\n      \"KEGG_PROTEASOME\", \"KEGG_CELL_CYCLE\",\n      \"REACTOME_IMMUNE_SYSTEM\", \"GO_DNA_REPAIR\",\n      \"HALLMARK_P53_PATHWAY\", \"KEGG_OXIDATIVE_PHOSPHORYLATION\",\n      \"REACTOME_CELL_CYCLE\", \"GO_MITOCHONDRION\",\n      \"HALLMARK_TNFA_SIGNALING_VIA_NFKB\"\n    ),\n    p_value = c(0.001, 0.002, 0.003, 0.004, 0.005, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1),\n    gene_count = c(25, 22, 20, 18, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6),\n    pathway_size = 200,\n    NES = c(2.3, 2.1, 1.9, -1.8, 1.7, -1.6, 1.5, 1.4, -1.3, 1.2, 1.1, -1.0, 0.9, 0.8, -0.7),\n    q_value = c(0.01, 0.01, 0.02, 0.02, 0.03, 0.05, 0.08, 0.1, 0.12, 0.15, 0.18, 0.2, 0.22, 0.24, 0.26),\n    stringsAsFactors = FALSE\n  )\n}\n\n# ============================================================================\n# Module: Data Loader\n# ============================================================================\n\nmod_data_loader_ui <- function(id) {\n  ns <- NS(id)\n  \n  tagList(\n    layout_columns(\n      col_widths = c(4, 8),\n      \n      card(\n        card_header(\"Data Source\"),\n        card_body(\n          radioButtons(\n            ns(\"data_source\"),\n            \"Select Data Source:\",\n            choices = list(\"Example Data (Simulated)\" = \"example\"),\n            selected = \"example\"\n          ),\n          \n          p(class = \"text-muted\",\n            \"This demo uses simulated CoMMpass-like data with:\",\n            tags$ul(\n              tags$li(\"500 genes, 40 samples\"),\n              tags$li(\"50 differentially expressed genes\"),\n              tags$li(\"Simulated survival outcomes\")\n            )\n          ),\n          \n          hr(),\n          \n          actionButton(\n            ns(\"load_data\"),\n            \"Load Example Data\",\n            class = \"btn-primary btn-lg\",\n            icon = icon(\"play\")\n          ),\n          \n          br(), br(),\n          \n          verbatimTextOutput(ns(\"load_status\"))\n        )\n      ),\n      \n      card(\n        card_header(\"Data Summary\"),\n        card_body(\n          h5(\"Loaded Datasets\"),\n          tableOutput(ns(\"data_summary\")),\n          \n          hr(),\n          \n          h5(\"Sample Distribution\"),\n          plotlyOutput(ns(\"sample_distribution\"), height = \"250px\"),\n          \n          hr(),\n          \n          h5(\"Data Preview\"),\n          DTOutput(ns(\"data_preview\"))\n        )\n      )\n    )\n  )\n}\n\nmod_data_loader_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    observeEvent(input$load_data, {\n      withProgress(message = 'Generating example data...', value = 0, {\n        \n        incProgress(0.2, detail = \"Generating counts matrix\")\n        counts <- generate_example_counts(n_genes = 500, n_samples = 40)\n        \n        incProgress(0.4, detail = \"Generating clinical data\")\n        clinical <- generate_example_clinical(n_samples = 40)\n        \n        incProgress(0.6, detail = \"Calculating QC metrics\")\n        qc_metrics <- generate_example_qc(counts)\n        \n        incProgress(0.8, detail = \"Simulating DE results\")\n        de_results <- generate_example_de(counts)\n        \n        incProgress(0.9, detail = \"Generating pathway results\")\n        pathway_results <- generate_example_pathways()\n        \n        shared_data$raw_data <- list(counts = counts, clinical = clinical)\n        shared_data$qc_metrics <- qc_metrics\n        shared_data$de_results <- de_results\n        shared_data$survival_data <- clinical\n        shared_data$pathway_results <- pathway_results\n        \n        incProgress(1.0, detail = \"Complete!\")\n      })\n      \n      output$load_status <- renderText(\"Example data loaded successfully!\\nReady to explore the dashboard.\")\n    })\n    \n    output$data_summary <- renderTable({\n      req(shared_data$raw_data)\n      \n      data.frame(\n        Dataset = c(\"Expression Data\", \"QC Metrics\", \"DE Results\", \"Survival Data\", \"Pathway Results\"),\n        Status = c(\n          ifelse(is.null(shared_data$raw_data), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$qc_metrics), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$de_results), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$survival_data), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$pathway_results), \"Not loaded\", \"Loaded\")\n        ),\n        Dimensions = c(\n          if (!is.null(shared_data$raw_data)) paste(dim(shared_data$raw_data$counts), collapse = \" x \") else \"-\",\n          if (!is.null(shared_data$qc_metrics)) paste(dim(shared_data$qc_metrics), collapse = \" x \") else \"-\",\n          if (!is.null(shared_data$de_results)) paste(length(shared_data$de_results), \"methods\") else \"-\",\n          if (!is.null(shared_data$survival_data)) paste(dim(shared_data$survival_data), collapse = \" x \") else \"-\",\n          if (!is.null(shared_data$pathway_results)) paste(dim(shared_data$pathway_results), collapse = \" x \") else \"-\"\n        ),\n        stringsAsFactors = FALSE\n      )\n    })\n    \n    output$sample_distribution <- renderPlotly({\n      req(shared_data$qc_metrics)\n      \n      plot_ly(\n        data = shared_data$qc_metrics,\n        x = ~total_counts,\n        y = ~detected_genes,\n        type = 'scatter',\n        mode = 'markers',\n        marker = list(size = 10, color = ~total_counts, colorscale = 'Viridis', showscale = TRUE),\n        text = ~paste(\"Sample:\", sample, \"<br>Total counts:\", format(total_counts, big.mark = \",\"), \n                     \"<br>Detected genes:\", detected_genes),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          xaxis = list(title = \"Total Counts\"),\n          yaxis = list(title = \"Detected Genes\"),\n          hovermode = 'closest',\n          margin = list(l = 50, r = 50, t = 20, b = 50)\n        )\n    })\n    \n    output$data_preview <- renderDT({\n      req(shared_data$qc_metrics)\n      \n      datatable(\n        shared_data$qc_metrics,\n        options = list(pageLength = 5, scrollX = TRUE, dom = 'tp'),\n        rownames = FALSE\n      )\n    })\n    \n    return(reactive({\n      list(loaded = !is.null(shared_data$raw_data), source = input$data_source)\n    }))\n  })\n}\n\n# ============================================================================\n# Module: QC Visualization\n# ============================================================================\n\nmod_qc_viz_ui <- function(id) {\n  ns <- NS(id)\n  \n  tagList(\n    card(\n      card_header(\"Quality Control Metrics\"),\n      card_body(\n        layout_columns(\n          col_widths = c(6, 6),\n          plotlyOutput(ns(\"library_size_plot\"), height = \"350px\"),\n          plotlyOutput(ns(\"pca_plot\"), height = \"350px\")\n        ),\n        hr(),\n        h5(\"Sample QC Table\"),\n        DTOutput(ns(\"qc_table\"))\n      )\n    )\n  )\n}\n\nmod_qc_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    output$library_size_plot <- renderPlotly({\n      req(shared_data$qc_metrics)\n      \n      plot_ly(\n        data = shared_data$qc_metrics,\n        x = ~sample,\n        y = ~total_counts,\n        type = 'bar',\n        marker = list(color = ~total_counts, colorscale = 'Blues', showscale = FALSE),\n        text = ~paste(\"Sample:\", sample, \"<br>Total counts:\", format(total_counts, big.mark = \",\")),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Library Size Distribution\",\n          xaxis = list(title = \"Sample\", tickangle = -45),\n          yaxis = list(title = \"Total Counts\"),\n          margin = list(b = 100)\n        )\n    })\n    \n    output$pca_plot <- renderPlotly({\n      req(shared_data$raw_data)\n      \n      if (is.list(shared_data$raw_data) && \"counts\" %in% names(shared_data$raw_data)) {\n        counts <- shared_data$raw_data$counts\n        log_counts <- log2(counts + 1)\n        pca_result <- prcomp(t(log_counts), scale. = TRUE, center = TRUE)\n        \n        pc_df <- data.frame(\n          sample = rownames(pca_result$x),\n          PC1 = pca_result$x[,1],\n          PC2 = pca_result$x[,2]\n        )\n        \n        var_explained <- round(100 * pca_result$sdev^2 / sum(pca_result$sdev^2), 1)\n        \n        plot_ly(\n          data = pc_df,\n          x = ~PC1,\n          y = ~PC2,\n          type = 'scatter',\n          mode = 'markers',\n          marker = list(size = 12, color = \"#2E86AB\"),\n          text = ~sample,\n          hovertemplate = \"Sample: %{text}<br>PC1: %{x:.2f}<br>PC2: %{y:.2f}<extra><\/extra>\"\n        ) %>%\n          layout(\n            title = \"PCA of Samples\",\n            xaxis = list(title = paste0(\"PC1 (\", var_explained[1], \"% variance)\")),\n            yaxis = list(title = paste0(\"PC2 (\", var_explained[2], \"% variance)\"))\n          )\n      } else {\n        plot_ly() %>% layout(title = \"PCA Plot\", annotations = list(text = \"No data\", showarrow = FALSE))\n      }\n    })\n    \n    output$qc_table <- renderDT({\n      req(shared_data$qc_metrics)\n      datatable(shared_data$qc_metrics, options = list(pageLength = 10, scrollX = TRUE), rownames = FALSE)\n    })\n  })\n}\n\n# ============================================================================\n# Module: Differential Expression\n# ============================================================================\n\nmod_de_viz_ui <- function(id) {\n  ns <- NS(id)\n  \n  tagList(\n    layout_columns(\n      col_widths = c(3, 9),\n      \n      card(\n        card_header(\"DE Analysis Controls\"),\n        card_body(\n          selectInput(ns(\"de_method\"), \"Select Method:\", \n                     choices = c(\"DESeq2\", \"edgeR\", \"limma\"), selected = \"DESeq2\"),\n          sliderInput(ns(\"padj_threshold\"), \"Adjusted P-value:\", min = 0.001, max = 0.1, value = 0.05, step = 0.001),\n          sliderInput(ns(\"lfc_threshold\"), \"Log2 Fold Change:\", min = 0, max = 3, value = 1, step = 0.1),\n          hr(),\n          h5(\"Summary\"),\n          tableOutput(ns(\"de_summary\"))\n        )\n      ),\n      \n      card(\n        card_header(\"Differential Expression Results\"),\n        card_body(\n          navset_tab(\n            nav_panel(\"Volcano Plot\", plotlyOutput(ns(\"volcano_plot\"), height = \"500px\")),\n            nav_panel(\"MA Plot\", plotlyOutput(ns(\"ma_plot\"), height = \"500px\")),\n            nav_panel(\"DE Table\", DTOutput(ns(\"de_table\")))\n          )\n        )\n      )\n    )\n  )\n}\n\nmod_de_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    current_de_results <- reactive({\n      req(shared_data$de_results)\n      if (is.list(shared_data$de_results) && input$de_method %in% names(shared_data$de_results)) {\n        shared_data$de_results[[input$de_method]]\n      } else {\n        shared_data$de_results[[1]]\n      }\n    })\n    \n    output$de_summary <- renderTable({\n      req(current_de_results())\n      df <- current_de_results()\n      \n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else if (\"FDR\" %in% names(df)) \"FDR\" else \"adj.P.Val\"\n      lfc_col <- if (\"log2FoldChange\" %in% names(df)) \"log2FoldChange\" else if (\"logFC\" %in% names(df)) \"logFC\" else \"log2FC\"\n      \n      n_sig <- sum(df[[padj_col]] < input$padj_threshold, na.rm = TRUE)\n      n_up <- sum(df[[padj_col]] < input$padj_threshold & df[[lfc_col]] > input$lfc_threshold, na.rm = TRUE)\n      n_down <- sum(df[[padj_col]] < input$padj_threshold & df[[lfc_col]] < -input$lfc_threshold, na.rm = TRUE)\n      \n      data.frame(\n        Metric = c(\"Total Genes\", \"Significant\", \"Upregulated\", \"Downregulated\"),\n        Count = c(nrow(df), n_sig, n_up, n_down)\n      )\n    })\n    \n    output$volcano_plot <- renderPlotly({\n      req(current_de_results())\n      df <- current_de_results()\n      \n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else if (\"FDR\" %in% names(df)) \"FDR\" else \"adj.P.Val\"\n      lfc_col <- if (\"log2FoldChange\" %in% names(df)) \"log2FoldChange\" else if (\"logFC\" %in% names(df)) \"logFC\" else \"log2FC\"\n      \n      df$significance <- ifelse(\n        df[[padj_col]] < input$padj_threshold & abs(df[[lfc_col]]) > input$lfc_threshold,\n        ifelse(df[[lfc_col]] > 0, \"Up\", \"Down\"),\n        \"Not Significant\"\n      )\n      \n      colors <- c(\"Up\" = \"#DC3545\", \"Down\" = \"#0066CC\", \"Not Significant\" = \"#CCCCCC\")\n      \n      plot_ly(\n        data = df,\n        x = ~get(lfc_col),\n        y = ~-log10(get(padj_col)),\n        type = 'scatter',\n        mode = 'markers',\n        color = ~significance,\n        colors = colors,\n        marker = list(size = 5),\n        text = ~paste(\"Gene:\", gene, \"<br>Log2FC:\", round(get(lfc_col), 3), \n                     \"<br>Adj P:\", format(get(padj_col), digits = 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = paste(\"Volcano Plot -\", input$de_method),\n          xaxis = list(title = \"Log2 Fold Change\"),\n          yaxis = list(title = \"-Log10(Adjusted P-value)\"),\n          shapes = list(\n            list(type = 'line', x0 = input$lfc_threshold, x1 = input$lfc_threshold,\n                 y0 = 0, y1 = 1, yref = \"paper\",\n                 line = list(color = 'gray', dash = 'dash', width = 1)),\n            list(type = 'line', x0 = -input$lfc_threshold, x1 = -input$lfc_threshold,\n                 y0 = 0, y1 = 1, yref = \"paper\",\n                 line = list(color = 'gray', dash = 'dash', width = 1)),\n            list(type = 'line', x0 = 0, x1 = 1, xref = \"paper\",\n                 y0 = -log10(input$padj_threshold), y1 = -log10(input$padj_threshold),\n                 line = list(color = 'gray', dash = 'dash', width = 1))\n          )\n        )\n    })\n    \n    output$ma_plot <- renderPlotly({\n      req(current_de_results())\n      df <- current_de_results()\n      \n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else if (\"FDR\" %in% names(df)) \"FDR\" else \"adj.P.Val\"\n      lfc_col <- if (\"log2FoldChange\" %in% names(df)) \"log2FoldChange\" else if (\"logFC\" %in% names(df)) \"logFC\" else \"log2FC\"\n      \n      if (\"baseMean\" %in% names(df)) {\n        df$avg_expr <- log10(df$baseMean + 1)\n      } else if (\"AveExpr\" %in% names(df)) {\n        df$avg_expr <- df$AveExpr\n      } else {\n        df$avg_expr <- runif(nrow(df), 0, 5)\n      }\n      \n      df$significance <- ifelse(\n        df[[padj_col]] < input$padj_threshold & abs(df[[lfc_col]]) > input$lfc_threshold,\n        \"Significant\", \"Not Significant\"\n      )\n      \n      colors <- c(\"Significant\" = \"#DC3545\", \"Not Significant\" = \"#CCCCCC\")\n      \n      plot_ly(\n        data = df,\n        x = ~avg_expr,\n        y = ~get(lfc_col),\n        type = 'scatter',\n        mode = 'markers',\n        color = ~significance,\n        colors = colors,\n        marker = list(size = 4),\n        text = ~paste(\"Gene:\", gene, \"<br>Avg Expression:\", round(avg_expr, 2), \n                     \"<br>Log2FC:\", round(get(lfc_col), 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = paste(\"MA Plot -\", input$de_method),\n          xaxis = list(title = \"Average Expression (log10)\"),\n          yaxis = list(title = \"Log2 Fold Change\")\n        )\n    })\n    \n    output$de_table <- renderDT({\n      req(current_de_results())\n      df <- current_de_results()\n      numeric_cols <- sapply(df, is.numeric)\n      df[numeric_cols] <- lapply(df[numeric_cols], function(x) round(x, 4))\n      datatable(df, options = list(pageLength = 25, scrollX = TRUE), rownames = FALSE, filter = 'top')\n    })\n  })\n}\n\n# ============================================================================\n# Module: Survival Analysis\n# ============================================================================\n\nmod_survival_viz_ui <- function(id) {\n  ns <- NS(id)\n  \n  tagList(\n    layout_columns(\n      col_widths = c(3, 9),\n      \n      card(\n        card_header(\"Survival Controls\"),\n        card_body(\n          radioButtons(ns(\"survival_type\"), \"Survival Endpoint:\",\n                      choices = c(\"Overall Survival\" = \"os\", \"Progression-Free Survival\" = \"pfs\"),\n                      selected = \"os\"),\n          selectInput(ns(\"group_by\"), \"Group By:\",\n                     choices = c(\"Risk Group\" = \"risk_group\", \"ISS Stage\" = \"stage\", \"None\" = \"none\"),\n                     selected = \"risk_group\"),\n          hr(),\n          h5(\"Summary\"),\n          tableOutput(ns(\"survival_summary\"))\n        )\n      ),\n      \n      card(\n        card_header(\"Survival Analysis Results\"),\n        card_body(\n          plotlyOutput(ns(\"km_plot\"), height = \"500px\"),\n          hr(),\n          verbatimTextOutput(ns(\"km_stats\"))\n        )\n      )\n    )\n  )\n}\n\nmod_survival_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    output$survival_summary <- renderTable({\n      req(shared_data$survival_data)\n      surv_data <- shared_data$survival_data\n      \n      time_col <- if (input$survival_type == \"os\") \"os_time\" else \"pfs_time\"\n      status_col <- if (input$survival_type == \"os\") \"os_status\" else \"pfs_status\"\n      \n      if (time_col %in% names(surv_data) && status_col %in% names(surv_data)) {\n        data.frame(\n          Metric = c(\"Total Patients\", \"Events\", \"Censored\", \"Median Follow-up\"),\n          Value = c(\n            nrow(surv_data),\n            sum(surv_data[[status_col]], na.rm = TRUE),\n            sum(!surv_data[[status_col]], na.rm = TRUE),\n            round(median(surv_data[[time_col]], na.rm = TRUE), 1)\n          )\n        )\n      } else {\n        data.frame(Metric = \"No data\", Value = \"-\")\n      }\n    })\n    \n    output$km_plot <- renderPlotly({\n      req(shared_data$survival_data)\n      \n      surv_data <- shared_data$survival_data\n      time_col <- if (input$survival_type == \"os\") \"os_time\" else \"pfs_time\"\n      status_col <- if (input$survival_type == \"os\") \"os_status\" else \"pfs_status\"\n      title_text <- if (input$survival_type == \"os\") \"Overall Survival\" else \"Progression-Free Survival\"\n      \n      if (!time_col %in% names(surv_data) || !status_col %in% names(surv_data)) {\n        return(plot_ly() %>% layout(title = title_text, \n                                    annotations = list(text = \"No data\", showarrow = FALSE)))\n      }\n      \n      if (input$group_by != \"none\" && input$group_by %in% names(surv_data)) {\n        formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ \", input$group_by))\n        fit <- survfit(formula, data = surv_data)\n        \n        groups <- unique(surv_data[[input$group_by]])\n        colors <- c(\"#2E86AB\", \"#A23B72\", \"#F18F01\")\n        \n        p <- plot_ly()\n        for (i in seq_along(groups)) {\n          idx <- which(fit$strata == i)\n          if (length(idx) > 0) {\n            p <- add_trace(p,\n              x = c(0, fit$time[idx]),\n              y = c(1, fit$surv[idx]),\n              type = 'scatter',\n              mode = 'lines',\n              line = list(shape = 'hv', color = colors[i], width = 2),\n              name = as.character(groups[i]),\n              hovertemplate = paste0(\"Time: %{x}<br>Survival: %{y:.2%}<extra><\/extra>\")\n            )\n          }\n        }\n        \n        p <- layout(p,\n          title = paste(title_text, \"by\", input$group_by),\n          xaxis = list(title = \"Time (days)\"),\n          yaxis = list(title = \"Survival Probability\", range = c(0, 1))\n        )\n      } else {\n        formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ 1\"))\n        fit <- survfit(formula, data = surv_data)\n        \n        p <- plot_ly(\n          x = c(0, fit$time),\n          y = c(1, fit$surv),\n          type = 'scatter',\n          mode = 'lines',\n          line = list(shape = 'hv', color = '#2E86AB', width = 2),\n          hovertemplate = \"Time: %{x}<br>Survival: %{y:.2%}<extra><\/extra>\"\n        ) %>%\n          layout(\n            title = title_text,\n            xaxis = list(title = \"Time (days)\"),\n            yaxis = list(title = \"Survival Probability\", range = c(0, 1))\n          )\n      }\n      \n      p\n    })\n    \n    output$km_stats <- renderPrint({\n      req(shared_data$survival_data)\n      \n      surv_data <- shared_data$survival_data\n      time_col <- if (input$survival_type == \"os\") \"os_time\" else \"pfs_time\"\n      status_col <- if (input$survival_type == \"os\") \"os_status\" else \"pfs_status\"\n      \n      if (time_col %in% names(surv_data) && status_col %in% names(surv_data)) {\n        if (input$group_by != \"none\" && input$group_by %in% names(surv_data)) {\n          formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ \", input$group_by))\n          survdiff_result <- survdiff(formula, data = surv_data)\n          p_value <- 1 - pchisq(survdiff_result$chisq, length(survdiff_result$n) - 1)\n          cat(\"Log-rank test p-value:\", format(p_value, digits = 4), \"\\n\\n\")\n          fit <- survfit(formula, data = surv_data)\n          print(fit)\n        } else {\n          formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ 1\"))\n          fit <- survfit(formula, data = surv_data)\n          print(fit)\n        }\n      } else {\n        cat(\"Survival data not available\")\n      }\n    })\n  })\n}\n\n# ============================================================================\n# Module: Pathway Analysis\n# ============================================================================\n\nmod_pathway_viz_ui <- function(id) {\n  ns <- NS(id)\n  \n  tagList(\n    card(\n      card_header(\"Pathway Analysis Results\"),\n      card_body(\n        navset_tab(\n          nav_panel(\n            \"Enrichment Results\",\n            layout_columns(\n              col_widths = c(6, 6),\n              plotlyOutput(ns(\"enrichment_plot\"), height = \"500px\"),\n              plotlyOutput(ns(\"dotplot\"), height = \"500px\")\n            ),\n            hr(),\n            DTOutput(ns(\"pathway_table\"))\n          ),\n          nav_panel(\n            \"GSEA Results\",\n            plotlyOutput(ns(\"gsea_plot\"), height = \"500px\"),\n            hr(),\n            DTOutput(ns(\"gsea_table\"))\n          )\n        )\n      )\n    )\n  )\n}\n\nmod_pathway_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    output$enrichment_plot <- renderPlotly({\n      req(shared_data$pathway_results)\n      df <- shared_data$pathway_results\n      \n      if (!all(c(\"pathway\", \"p_value\") %in% names(df))) {\n        return(plot_ly() %>% layout(title = \"No data\"))\n      }\n      \n      top_pathways <- df %>%\n        arrange(p_value) %>%\n        head(15) %>%\n        mutate(\n          neg_log_p = -log10(p_value),\n          pathway = factor(pathway, levels = rev(pathway))\n        )\n      \n      plot_ly(\n        data = top_pathways,\n        x = ~neg_log_p,\n        y = ~pathway,\n        type = 'bar',\n        orientation = 'h',\n        marker = list(color = ~neg_log_p, colorscale = list(c(0, \"#E8F4F8\"), c(1, \"#0066CC\")),\n                     showscale = TRUE, colorbar = list(title = \"-Log10(P)\")),\n        text = ~paste(\"Pathway:\", pathway, \"<br>P-value:\", format(p_value, digits = 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Top Enriched Pathways\",\n          xaxis = list(title = \"-Log10(P-value)\"),\n          yaxis = list(title = \"\", tickfont = list(size = 10)),\n          margin = list(l = 250)\n        )\n    })\n    \n    output$dotplot <- renderPlotly({\n      req(shared_data$pathway_results)\n      df <- shared_data$pathway_results\n      \n      top_pathways <- df %>% arrange(p_value) %>% head(15)\n      top_pathways$gene_ratio <- top_pathways$gene_count / top_pathways$pathway_size\n      top_pathways$q_value <- p.adjust(top_pathways$p_value, method = \"BH\")\n      \n      plot_ly(\n        data = top_pathways,\n        x = ~gene_ratio,\n        y = ~reorder(pathway, -p_value),\n        type = 'scatter',\n        mode = 'markers',\n        marker = list(size = ~gene_count * 2, color = ~-log10(q_value), colorscale = 'Reds',\n                     showscale = TRUE, colorbar = list(title = \"-Log10(Q)\")),\n        text = ~paste(\"Pathway:\", pathway, \"<br>Gene Ratio:\", round(gene_ratio, 3), \n                     \"<br>Q-value:\", format(q_value, digits = 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Pathway Enrichment Dotplot\",\n          xaxis = list(title = \"Gene Ratio\"),\n          yaxis = list(title = \"\", tickfont = list(size = 10)),\n          margin = list(l = 250)\n        )\n    })\n    \n    output$pathway_table <- renderDT({\n      req(shared_data$pathway_results)\n      datatable(shared_data$pathway_results, \n               options = list(pageLength = 25, scrollX = TRUE), \n               rownames = FALSE, filter = 'top')\n    })\n    \n    output$gsea_plot <- renderPlotly({\n      req(shared_data$pathway_results)\n      df <- shared_data$pathway_results\n      \n      if (\"NES\" %in% names(df)) {\n        sig_sets <- df %>% filter(q_value < 0.25) %>% arrange(desc(abs(NES))) %>% head(20)\n        \n        plot_ly(\n          data = sig_sets,\n          x = ~NES,\n          y = ~reorder(pathway, NES),\n          type = 'bar',\n          orientation = 'h',\n          marker = list(color = ~ifelse(NES > 0, \"#DC3545\", \"#0066CC\")),\n          text = ~paste(\"Gene Set:\", pathway, \"<br>NES:\", round(NES, 2), \n                       \"<br>Q-value:\", format(q_value, digits = 3)),\n          hovertemplate = \"%{text}<extra><\/extra>\"\n        ) %>%\n          layout(\n            title = \"GSEA - Normalized Enrichment Scores\",\n            xaxis = list(title = \"NES\", zeroline = TRUE),\n            yaxis = list(title = \"\", tickfont = list(size = 9)),\n            margin = list(l = 300)\n          )\n      } else {\n        plot_ly() %>% layout(title = \"No GSEA results\")\n      }\n    })\n    \n    output$gsea_table <- renderDT({\n      req(shared_data$pathway_results)\n      datatable(shared_data$pathway_results, \n               options = list(pageLength = 25, scrollX = TRUE), \n               rownames = FALSE)\n    })\n  })\n}\n\n# ============================================================================\n# Main App\n# ============================================================================\n\nui <- page_navbar(\n  title = \"CoMMpass Analysis Dashboard\",\n  theme = bs_theme(\n    version = 5,\n    primary = \"#0066CC\",\n    secondary = \"#6C757D\",\n    success = \"#28A745\",\n    info = \"#17A2B8\",\n    warning = \"#FFC107\",\n    danger = \"#DC3545\"\n  ),\n  \n  nav_panel(\n    title = \"Overview\",\n    icon = icon(\"home\"),\n    card(\n      card_header(\"CoMMpass Multiple Myeloma Analysis\"),\n      card_body(\n        h4(\"Welcome to the CoMMpass Analysis Dashboard\"),\n        p(\"This interactive dashboard runs entirely in your web browser using WebAssembly (Shinylive).\"),\n        hr(),\n        h5(\"Dataset Overview\"),\n        p(\"Simulated CoMMpass-like data includes:\"),\n        tags$ul(\n          tags$li(\"500 genes, 40 samples\"),\n          tags$li(\"RNA-seq expression data\"),\n          tags$li(\"Simulated survival outcomes\"),\n          tags$li(\"Pathway enrichment results\")\n        ),\n        hr(),\n        h5(\"Analysis Modules\"),\n        tags$ul(\n          tags$li(strong(\"Data:\"), \" Load and preview example data\"),\n          tags$li(strong(\"Quality Control:\"), \" Sample QC metrics, PCA visualization\"),\n          tags$li(strong(\"Differential Expression:\"), \" Volcano plots, MA plots (DESeq2, edgeR, limma)\"),\n          tags$li(strong(\"Survival Analysis:\"), \" Kaplan-Meier curves, log-rank tests\"),\n          tags$li(strong(\"Pathway Analysis:\"), \" Enrichment analysis and GSEA results\")\n        ),\n        hr(),\n        div(\n          class = \"alert alert-info\",\n          icon(\"info-circle\"),\n          \" Start by clicking the \", strong(\"Data\"), \" tab and loading the example dataset.\"\n        ),\n        hr(),\n        h5(\"Example ggplot2 Visualization\"),\n        p(\"Demonstrating ggplot2 works in Shinylive with all dependencies:\"),\n        plotOutput(\"example_ggplot\", height = \"300px\")\n      )\n    )\n  ),\n  \n  nav_panel(title = \"Data\", icon = icon(\"database\"), mod_data_loader_ui(\"data_loader\")),\n  nav_panel(title = \"Quality Control\", icon = icon(\"chart-line\"), mod_qc_viz_ui(\"qc_viz\")),\n  nav_panel(title = \"Differential Expression\", icon = icon(\"dna\"), mod_de_viz_ui(\"de_viz\")),\n  nav_panel(title = \"Survival Analysis\", icon = icon(\"heartbeat\"), mod_survival_viz_ui(\"survival_viz\")),\n  nav_panel(title = \"Pathway Analysis\", icon = icon(\"project-diagram\"), mod_pathway_viz_ui(\"pathway_viz\")),\n  \n  nav_panel(\n    title = \"About\",\n    icon = icon(\"info-circle\"),\n    card(\n      card_header(\"About This Dashboard\"),\n      card_body(\n        h5(\"Technology\"),\n        p(\"Built with R Shiny and Shinylive for browser-based execution without R server.\"),\n        p(\"All computations run in your browser using WebAssembly.\"),\n        hr(),\n        h5(\"Data Source\"),\n        p(\"This demo uses simulated data similar to the MMRF CoMMpass study (phs000748).\"),\n        hr(),\n        h5(\"Performance\"),\n        p(\"First load takes 30-60 seconds while packages download. Subsequent visits are faster due to browser caching.\")\n      )\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n  shared_data <- reactiveValues(\n    raw_data = NULL,\n    qc_metrics = NULL,\n    de_results = NULL,\n    survival_data = NULL,\n    pathway_results = NULL\n  )\n\n  # Example ggplot2 visualization showing it works with munsell colors\n  output$example_ggplot <- renderPlot({\n    set.seed(123)\n    data <- data.frame(\n      category = rep(c(\"High Risk\", \"Standard Risk\", \"Low Risk\"), each = 100),\n      value = c(rnorm(100, 5, 2), rnorm(100, 7, 1.5), rnorm(100, 9, 1))\n    )\n\n    ggplot(data, aes(x = category, y = value, fill = category)) +\n      geom_violin(alpha = 0.7) +\n      geom_boxplot(width = 0.2, alpha = 0.9) +\n      scale_fill_manual(values = c(\"High Risk\" = \"#E63946\",\n                                  \"Standard Risk\" = \"#F1C40F\",\n                                  \"Low Risk\" = \"#2ECC71\")) +\n      theme_minimal() +\n      theme(legend.position = \"none\",\n            plot.title = element_text(size = 14, face = \"bold\")) +\n      labs(title = \"Risk Stratification Distribution (ggplot2)\",\n           x = \"Risk Category\",\n           y = \"Expression Score\") +\n      coord_cartesian(ylim = c(0, 12))\n  })\n\n  mod_data_loader_server(\"data_loader\", shared_data)\n  mod_qc_viz_server(\"qc_viz\", shared_data)\n  mod_de_viz_server(\"de_viz\", shared_data)\n  mod_survival_viz_server(\"survival_viz\", shared_data)\n  mod_pathway_viz_server(\"pathway_viz\", shared_data)\n}\n\nshinyApp(ui = ui, server = server)\n","type":"text"},{"name":"modules/mod_data_loader.R","content":"# modules/mod_data_loader.R\n# Module for loading and managing CoMMpass analysis data\n\n#' Data Loader Module UI\nmod_data_loader_ui <- function(id) {\n  ns <- NS(id)\n\n  tagList(\n    layout_columns(\n      col_widths = c(4, 8),\n\n      # Left panel - Data source selection\n      card(\n        card_header(\"Data Source\"),\n        card_body(\n          radioButtons(\n            ns(\"data_source\"),\n            \"Select Data Source:\",\n            choices = list(\n              \"Example Data (Quick Start)\" = \"example\",\n              \"Upload Results (.RDS)\" = \"upload\",\n              \"Connect to targets\" = \"targets\"\n            ),\n            selected = \"example\"\n          ),\n\n          conditionalPanel(\n            condition = \"input.data_source == 'upload'\",\n            ns = ns,\n            fileInput(\n              ns(\"upload_files\"),\n              \"Upload Analysis Results:\",\n              multiple = TRUE,\n              accept = c(\".rds\", \".RDS\")\n            )\n          ),\n\n          conditionalPanel(\n            condition = \"input.data_source == 'targets'\",\n            ns = ns,\n            p(class = \"text-muted\",\n              \"This will load results from the targets pipeline.\",\n              \"Ensure the pipeline has been run first.\"\n            )\n          ),\n\n          hr(),\n\n          actionButton(\n            ns(\"load_data\"),\n            \"Load Data\",\n            class = \"btn-primary\",\n            icon = icon(\"download\")\n          ),\n\n          br(), br(),\n\n          verbatimTextOutput(ns(\"load_status\"))\n        )\n      ),\n\n      # Right panel - Data summary\n      card(\n        card_header(\"Data Summary\"),\n        card_body(\n          h5(\"Loaded Datasets\"),\n          tableOutput(ns(\"data_summary\")),\n\n          hr(),\n\n          h5(\"Sample Information\"),\n          plotlyOutput(ns(\"sample_distribution\")),\n\n          hr(),\n\n          h5(\"Data Preview\"),\n          DTOutput(ns(\"data_preview\"))\n        )\n      )\n    )\n  )\n}\n\n#' Data Loader Module Server\nmod_data_loader_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n\n    # Load data based on source selection\n    observeEvent(input$load_data, {\n\n      if (input$data_source == \"example\") {\n        # Load example data\n        tryCatch({\n          # Load pre-computed example results\n          example_dir <- \"../data/example/\"\n\n          shared_data$raw_data <- readRDS(file.path(example_dir, \"counts.rds\"))\n          shared_data$qc_metrics <- readRDS(file.path(example_dir, \"qc_metrics.rds\"))\n          shared_data$de_results <- readRDS(file.path(example_dir, \"de_results.rds\"))\n          shared_data$survival_data <- readRDS(file.path(example_dir, \"survival_data.rds\"))\n          shared_data$pathway_results <- readRDS(file.path(example_dir, \"pathway_results.rds\"))\n\n          output$load_status <- renderText(\"Example data loaded successfully!\")\n\n        }, error = function(e) {\n          # If pre-computed results don't exist, generate them\n          output$load_status <- renderText(\"Generating example data...\")\n\n          # Source the generation script\n          source(\"../R/generate_example_data.R\")\n\n          # Generate data\n          counts <- generate_counts_matrix(n_genes = 100, n_samples = 30)\n          clinical <- generate_clinical_data(n_samples = 30)\n\n          # Create mock analysis results\n          shared_data$raw_data <- list(\n            counts = counts,\n            clinical = clinical\n          )\n\n          shared_data$qc_metrics <- data.frame(\n            sample = colnames(counts),\n            total_counts = colSums(counts),\n            detected_genes = colSums(counts > 0),\n            stringsAsFactors = FALSE\n          )\n\n          shared_data$de_results <- list(\n            DESeq2 = data.frame(\n              gene = rownames(counts)[1:20],\n              log2FC = rnorm(20, 0, 2),\n              padj = runif(20, 0, 0.1),\n              stringsAsFactors = FALSE\n            )\n          )\n\n          shared_data$survival_data <- clinical\n\n          shared_data$pathway_results <- data.frame(\n            pathway = c(\"Cell cycle\", \"Apoptosis\", \"NF-kB signaling\"),\n            p_value = c(0.001, 0.01, 0.05),\n            gene_count = c(15, 12, 8),\n            stringsAsFactors = FALSE\n          )\n\n          output$load_status <- renderText(\"Example data generated successfully!\")\n        })\n\n      } else if (input$data_source == \"upload\") {\n        # Handle file upload\n        req(input$upload_files)\n\n        tryCatch({\n          files <- input$upload_files\n\n          for (i in 1:nrow(files)) {\n            file_name <- files$name[i]\n            file_path <- files$datapath[i]\n\n            if (grepl(\"qc\", file_name, ignore.case = TRUE)) {\n              shared_data$qc_metrics <- readRDS(file_path)\n            } else if (grepl(\"de|differential\", file_name, ignore.case = TRUE)) {\n              shared_data$de_results <- readRDS(file_path)\n            } else if (grepl(\"surv\", file_name, ignore.case = TRUE)) {\n              shared_data$survival_data <- readRDS(file_path)\n            } else if (grepl(\"path\", file_name, ignore.case = TRUE)) {\n              shared_data$pathway_results <- readRDS(file_path)\n            } else if (grepl(\"raw|counts\", file_name, ignore.case = TRUE)) {\n              shared_data$raw_data <- readRDS(file_path)\n            }\n          }\n\n          output$load_status <- renderText(\"Files uploaded successfully!\")\n\n        }, error = function(e) {\n          output$load_status <- renderText(paste(\"Error loading files:\", e$message))\n        })\n\n      } else if (input$data_source == \"targets\") {\n        # Load from targets pipeline\n        tryCatch({\n          library(targets)\n\n          # Load results from targets\n          shared_data$raw_data <- tar_read(raw_data)\n          shared_data$qc_metrics <- tar_read(qc_metrics)\n          shared_data$de_results <- tar_read(consensus_de_genes)\n          shared_data$survival_data <- tar_read(survival_data)\n          shared_data$pathway_results <- tar_read(pathway_results)\n\n          output$load_status <- renderText(\"Data loaded from targets pipeline!\")\n\n        }, error = function(e) {\n          output$load_status <- renderText(paste(\"Error loading from targets:\", e$message))\n        })\n      }\n    })\n\n    # Data summary table\n    output$data_summary <- renderTable({\n      req(shared_data$raw_data)\n\n      data.frame(\n        Dataset = c(\"Expression Data\", \"QC Metrics\", \"DE Results\",\n                   \"Survival Data\", \"Pathway Results\"),\n        Status = c(\n          ifelse(is.null(shared_data$raw_data), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$qc_metrics), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$de_results), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$survival_data), \"Not loaded\", \"Loaded\"),\n          ifelse(is.null(shared_data$pathway_results), \"Not loaded\", \"Loaded\")\n        ),\n        Dimensions = c(\n          if (!is.null(shared_data$raw_data)) {\n            if (is.list(shared_data$raw_data) && \"counts\" %in% names(shared_data$raw_data)) {\n              paste(dim(shared_data$raw_data$counts), collapse = \" x \")\n            } else \"N/A\"\n          } else \"-\",\n          if (!is.null(shared_data$qc_metrics)) {\n            paste(dim(shared_data$qc_metrics), collapse = \" x \")\n          } else \"-\",\n          if (!is.null(shared_data$de_results)) {\n            if (is.list(shared_data$de_results)) {\n              paste(length(shared_data$de_results), \"methods\")\n            } else paste(dim(shared_data$de_results), collapse = \" x \")\n          } else \"-\",\n          if (!is.null(shared_data$survival_data)) {\n            paste(dim(shared_data$survival_data), collapse = \" x \")\n          } else \"-\",\n          if (!is.null(shared_data$pathway_results)) {\n            paste(dim(shared_data$pathway_results), collapse = \" x \")\n          } else \"-\"\n        ),\n        stringsAsFactors = FALSE\n      )\n    })\n\n    # Sample distribution plot\n    output$sample_distribution <- renderPlotly({\n      req(shared_data$qc_metrics)\n\n      p <- plot_ly(\n        data = shared_data$qc_metrics,\n        x = ~total_counts,\n        y = ~detected_genes,\n        type = 'scatter',\n        mode = 'markers',\n        marker = list(\n          size = 10,\n          color = ~total_counts,\n          colorscale = 'Viridis',\n          showscale = TRUE\n        ),\n        text = ~paste(\"Sample:\", sample,\n                     \"<br>Total counts:\", format(total_counts, big.mark = \",\"),\n                     \"<br>Detected genes:\", detected_genes),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Sample Distribution\",\n          xaxis = list(title = \"Total Counts\"),\n          yaxis = list(title = \"Detected Genes\"),\n          hovermode = 'closest'\n        )\n\n      p\n    })\n\n    # Data preview table\n    output$data_preview <- renderDT({\n      req(shared_data$qc_metrics)\n\n      datatable(\n        shared_data$qc_metrics,\n        options = list(\n          pageLength = 5,\n          scrollX = TRUE,\n          dom = 'tp'\n        ),\n        rownames = FALSE\n      )\n    })\n\n    # Return loaded data status\n    return(reactive({\n      list(\n        loaded = !is.null(shared_data$raw_data),\n        source = input$data_source\n      )\n    }))\n  })\n}","type":"text"},{"name":"modules/mod_de_viz.R","content":"# modules/mod_de_viz.R\n# Module for differential expression visualization\n\n#' DE Visualization Module UI\nmod_de_viz_ui <- function(id) {\n  ns <- NS(id)\n\n  tagList(\n    layout_columns(\n      col_widths = c(3, 9),\n\n      # Left panel - Controls\n      card(\n        card_header(\"DE Analysis Controls\"),\n        card_body(\n          selectInput(\n            ns(\"de_method\"),\n            \"Select Method:\",\n            choices = c(\"DESeq2\", \"edgeR\", \"limma\", \"Consensus\"),\n            selected = \"Consensus\"\n          ),\n\n          sliderInput(\n            ns(\"padj_threshold\"),\n            \"Adjusted P-value Threshold:\",\n            min = 0.001,\n            max = 0.1,\n            value = 0.05,\n            step = 0.001\n          ),\n\n          sliderInput(\n            ns(\"lfc_threshold\"),\n            \"Log2 Fold Change Threshold:\",\n            min = 0,\n            max = 3,\n            value = 1,\n            step = 0.1\n          ),\n\n          hr(),\n\n          h5(\"Summary Statistics\"),\n          tableOutput(ns(\"de_summary\"))\n        )\n      ),\n\n      # Right panel - Visualizations\n      card(\n        card_header(\"Differential Expression Results\"),\n        card_body(\n          navset_tab(\n            nav_panel(\n              \"Volcano Plot\",\n              plotlyOutput(ns(\"volcano_plot\"), height = \"500px\")\n            ),\n            nav_panel(\n              \"MA Plot\",\n              plotlyOutput(ns(\"ma_plot\"), height = \"500px\")\n            ),\n            nav_panel(\n              \"Heatmap\",\n              plotlyOutput(ns(\"heatmap\"), height = \"600px\")\n            ),\n            nav_panel(\n              \"DE Table\",\n              DTOutput(ns(\"de_table\"))\n            ),\n            nav_panel(\n              \"Method Comparison\",\n              plotlyOutput(ns(\"venn_diagram\"), height = \"500px\")\n            )\n          )\n        )\n      )\n    )\n  )\n}\n\n#' DE Visualization Module Server\nmod_de_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n\n    # Get current DE results based on method selection\n    current_de_results <- reactive({\n      req(shared_data$de_results)\n\n      if (input$de_method == \"Consensus\") {\n        # Return consensus results if available\n        if (is.list(shared_data$de_results) && \"consensus_table\" %in% names(shared_data$de_results)) {\n          shared_data$de_results$consensus_table\n        } else if (is.list(shared_data$de_results) && \"DESeq2\" %in% names(shared_data$de_results)) {\n          # Use first available method\n          shared_data$de_results[[1]]\n        } else {\n          shared_data$de_results\n        }\n      } else {\n        # Return specific method results\n        if (is.list(shared_data$de_results) && input$de_method %in% names(shared_data$de_results)) {\n          shared_data$de_results[[input$de_method]]\n        } else {\n          shared_data$de_results\n        }\n      }\n    })\n\n    # DE summary statistics\n    output$de_summary <- renderTable({\n      req(current_de_results())\n\n      df <- current_de_results()\n\n      # Find appropriate columns\n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else\n                  if (\"FDR\" %in% names(df)) \"FDR\" else\n                  if (\"adj.P.Val\" %in% names(df)) \"adj.P.Val\" else NULL\n\n      lfc_col <- if (\"log2FoldChange\" %in% names(df)) \"log2FoldChange\" else\n                 if (\"log2FC\" %in% names(df)) \"log2FC\" else\n                 if (\"logFC\" %in% names(df)) \"logFC\" else NULL\n\n      if (!is.null(padj_col) && !is.null(lfc_col)) {\n        n_sig <- sum(df[[padj_col]] < input$padj_threshold, na.rm = TRUE)\n        n_up <- sum(df[[padj_col]] < input$padj_threshold &\n                   df[[lfc_col]] > input$lfc_threshold, na.rm = TRUE)\n        n_down <- sum(df[[padj_col]] < input$padj_threshold &\n                     df[[lfc_col]] < -input$lfc_threshold, na.rm = TRUE)\n      } else {\n        n_sig <- n_up <- n_down <- 0\n      }\n\n      data.frame(\n        Metric = c(\"Total Genes\", \"Significant\", \"Upregulated\", \"Downregulated\"),\n        Count = c(nrow(df), n_sig, n_up, n_down),\n        stringsAsFactors = FALSE\n      )\n    })\n\n    # Volcano plot\n    output$volcano_plot <- renderPlotly({\n      req(current_de_results())\n\n      df <- current_de_results()\n\n      # Find appropriate columns\n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else\n                  if (\"FDR\" %in% names(df)) \"FDR\" else\n                  if (\"adj.P.Val\" %in% names(df)) \"adj.P.Val\" else \"p_value\"\n\n      lfc_col <- if (\"log2FoldChange\" %in% names(df)) \"log2FoldChange\" else\n                 if (\"log2FC\" %in% names(df)) \"log2FC\" else\n                 if (\"logFC\" %in% names(df)) \"logFC\" else \"log2FC\"\n\n      gene_col <- if (\"gene\" %in% names(df)) \"gene\" else rownames(df)\n\n      # Add significance status\n      df$significance <- ifelse(\n        df[[padj_col]] < input$padj_threshold & abs(df[[lfc_col]]) > input$lfc_threshold,\n        ifelse(df[[lfc_col]] > 0, \"Up\", \"Down\"),\n        \"Not Significant\"\n      )\n\n      # Color mapping\n      colors <- c(\"Up\" = \"#DC3545\", \"Down\" = \"#0066CC\", \"Not Significant\" = \"#CCCCCC\")\n\n      p <- plot_ly(\n        data = df,\n        x = ~get(lfc_col),\n        y = ~-log10(get(padj_col)),\n        type = 'scatter',\n        mode = 'markers',\n        color = ~significance,\n        colors = colors,\n        marker = list(size = 5),\n        text = ~paste(\"Gene:\", if(is.character(gene_col)) gene_col else gene,\n                     \"<br>Log2FC:\", round(get(lfc_col), 3),\n                     \"<br>Adj P-value:\", format(get(padj_col), digits = 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = paste(\"Volcano Plot -\", input$de_method),\n          xaxis = list(title = \"Log2 Fold Change\"),\n          yaxis = list(title = \"-Log10(Adjusted P-value)\"),\n          shapes = list(\n            # Vertical lines for fold change threshold\n            list(type = 'line', x0 = input$lfc_threshold, x1 = input$lfc_threshold,\n                 y0 = 0, y1 = 1, yref = \"paper\",\n                 line = list(color = 'gray', dash = 'dash', width = 1)),\n            list(type = 'line', x0 = -input$lfc_threshold, x1 = -input$lfc_threshold,\n                 y0 = 0, y1 = 1, yref = \"paper\",\n                 line = list(color = 'gray', dash = 'dash', width = 1)),\n            # Horizontal line for p-value threshold\n            list(type = 'line', x0 = 0, x1 = 1, xref = \"paper\",\n                 y0 = -log10(input$padj_threshold), y1 = -log10(input$padj_threshold),\n                 line = list(color = 'gray', dash = 'dash', width = 1))\n          )\n        )\n\n      p\n    })\n\n    # MA plot\n    output$ma_plot <- renderPlotly({\n      req(current_de_results())\n\n      df <- current_de_results()\n\n      # Find appropriate columns\n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else\n                  if (\"FDR\" %in% names(df)) \"FDR\" else\n                  if (\"adj.P.Val\" %in% names(df)) \"adj.P.Val\" else \"p_value\"\n\n      lfc_col <- if (\"log2FoldChange\" %in% names(df)) \"log2FoldChange\" else\n                 if (\"log2FC\" %in% names(df)) \"log2FC\" else\n                 if (\"logFC\" %in% names(df)) \"logFC\" else \"log2FC\"\n\n      # Use baseMean if available, otherwise generate mock data\n      if (\"baseMean\" %in% names(df)) {\n        df$avg_expr <- log10(df$baseMean + 1)\n      } else if (\"AveExpr\" %in% names(df)) {\n        df$avg_expr <- df$AveExpr\n      } else {\n        df$avg_expr <- runif(nrow(df), 0, 5)\n      }\n\n      # Add significance status\n      df$significance <- ifelse(\n        df[[padj_col]] < input$padj_threshold & abs(df[[lfc_col]]) > input$lfc_threshold,\n        \"Significant\",\n        \"Not Significant\"\n      )\n\n      colors <- c(\"Significant\" = \"#DC3545\", \"Not Significant\" = \"#CCCCCC\")\n\n      p <- plot_ly(\n        data = df,\n        x = ~avg_expr,\n        y = ~get(lfc_col),\n        type = 'scatter',\n        mode = 'markers',\n        color = ~significance,\n        colors = colors,\n        marker = list(size = 4),\n        text = ~paste(\"Gene:\", if(\"gene\" %in% names(df)) gene else rownames(df),\n                     \"<br>Avg Expression:\", round(avg_expr, 2),\n                     \"<br>Log2FC:\", round(get(lfc_col), 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = paste(\"MA Plot -\", input$de_method),\n          xaxis = list(title = \"Average Expression (log10)\"),\n          yaxis = list(title = \"Log2 Fold Change\"),\n          shapes = list(\n            # Horizontal lines for fold change threshold\n            list(type = 'line', x0 = 0, x1 = 1, xref = \"paper\",\n                 y0 = input$lfc_threshold, y1 = input$lfc_threshold,\n                 line = list(color = 'gray', dash = 'dash', width = 1)),\n            list(type = 'line', x0 = 0, x1 = 1, xref = \"paper\",\n                 y0 = -input$lfc_threshold, y1 = -input$lfc_threshold,\n                 line = list(color = 'gray', dash = 'dash', width = 1))\n          )\n        )\n\n      p\n    })\n\n    # Heatmap of top DE genes\n    output$heatmap <- renderPlotly({\n      req(current_de_results())\n      req(shared_data$raw_data)\n\n      df <- current_de_results()\n\n      # Get top 30 genes\n      padj_col <- if (\"padj\" %in% names(df)) \"padj\" else\n                  if (\"FDR\" %in% names(df)) \"FDR\" else\n                  if (\"adj.P.Val\" %in% names(df)) \"adj.P.Val\" else \"p_value\"\n\n      top_genes <- df %>%\n        arrange(!!sym(padj_col)) %>%\n        head(30)\n\n      gene_col <- if (\"gene\" %in% names(top_genes)) top_genes$gene else rownames(top_genes)\n\n      # Get expression data\n      if (is.list(shared_data$raw_data) && \"counts\" %in% names(shared_data$raw_data)) {\n        counts <- shared_data$raw_data$counts\n\n        # Filter to top genes\n        if (all(gene_col %in% rownames(counts))) {\n          expr_matrix <- log2(counts[gene_col, ] + 1)\n        } else {\n          # Generate mock data if genes don't match\n          expr_matrix <- matrix(\n            rnorm(30 * 10, mean = 5, sd = 2),\n            nrow = 30,\n            dimnames = list(gene_col[1:30], paste0(\"Sample\", 1:10))\n          )\n        }\n\n        # Scale rows\n        expr_scaled <- t(scale(t(expr_matrix)))\n\n        p <- plot_ly(\n          z = expr_scaled,\n          x = colnames(expr_scaled),\n          y = rownames(expr_scaled),\n          type = 'heatmap',\n          colorscale = 'RdBu',\n          reversescale = TRUE,\n          hovertemplate = \"Gene: %{y}<br>Sample: %{x}<br>Z-score: %{z:.2f}<extra><\/extra>\"\n        ) %>%\n          layout(\n            title = \"Top 30 DE Genes Heatmap\",\n            xaxis = list(title = \"Samples\", tickangle = -45),\n            yaxis = list(title = \"Genes\"),\n            margin = list(l = 100, b = 100)\n          )\n      } else {\n        p <- plot_ly() %>%\n          layout(\n            title = \"Heatmap\",\n            annotations = list(\n              text = \"No expression data available\",\n              showarrow = FALSE,\n              xref = \"paper\",\n              yref = \"paper\",\n              x = 0.5,\n              y = 0.5\n            )\n          )\n      }\n\n      p\n    })\n\n    # DE results table\n    output$de_table <- renderDT({\n      req(current_de_results())\n\n      df <- current_de_results()\n\n      # Round numeric columns\n      numeric_cols <- sapply(df, is.numeric)\n      df[numeric_cols] <- lapply(df[numeric_cols], function(x) round(x, 4))\n\n      datatable(\n        df,\n        options = list(\n          pageLength = 25,\n          scrollX = TRUE,\n          dom = 'Bfrtip',\n          buttons = c('copy', 'csv', 'excel')\n        ),\n        rownames = FALSE,\n        extensions = 'Buttons',\n        filter = 'top'\n      )\n    })\n\n    # Venn diagram / method comparison\n    output$venn_diagram <- renderPlotly({\n      req(shared_data$de_results)\n\n      if (is.list(shared_data$de_results) && length(shared_data$de_results) > 1) {\n        # Count significant genes per method\n        method_counts <- sapply(names(shared_data$de_results), function(method) {\n          df <- shared_data$de_results[[method]]\n          if (is.data.frame(df)) {\n            padj_col <- if (\"padj\" %in% names(df)) \"padj\" else\n                       if (\"FDR\" %in% names(df)) \"FDR\" else\n                       if (\"adj.P.Val\" %in% names(df)) \"adj.P.Val\" else NULL\n            if (!is.null(padj_col)) {\n              sum(df[[padj_col]] < input$padj_threshold, na.rm = TRUE)\n            } else 0\n          } else 0\n        })\n\n        p <- plot_ly(\n          x = names(method_counts),\n          y = method_counts,\n          type = 'bar',\n          marker = list(color = '#2E86AB')\n        ) %>%\n          layout(\n            title = \"DE Genes by Method\",\n            xaxis = list(title = \"Method\"),\n            yaxis = list(title = \"Number of Significant Genes\")\n          )\n      } else {\n        p <- plot_ly() %>%\n          layout(\n            title = \"Method Comparison\",\n            annotations = list(\n              text = \"Multiple methods required for comparison\",\n              showarrow = FALSE,\n              xref = \"paper\",\n              yref = \"paper\",\n              x = 0.5,\n              y = 0.5\n            )\n          )\n      }\n\n      p\n    })\n  })\n}","type":"text"},{"name":"modules/mod_pathway_viz.R","content":"# modules/mod_pathway_viz.R\n# Module for pathway analysis visualization\n\n#' Pathway Visualization Module UI\nmod_pathway_viz_ui <- function(id) {\n  ns <- NS(id)\n\n  tagList(\n    layout_columns(\n      col_widths = c(12),\n\n      card(\n        card_header(\"Pathway Analysis Results\"),\n        card_body(\n          navset_tab(\n            nav_panel(\n              \"Enrichment Results\",\n              layout_columns(\n                col_widths = c(6, 6),\n                plotlyOutput(ns(\"enrichment_plot\"), height = \"500px\"),\n                plotlyOutput(ns(\"dotplot\"), height = \"500px\")\n              ),\n              hr(),\n              DTOutput(ns(\"pathway_table\"))\n            ),\n            nav_panel(\n              \"GSEA Results\",\n              layout_columns(\n                col_widths = c(6, 6),\n                plotlyOutput(ns(\"gsea_plot\"), height = \"500px\"),\n                plotlyOutput(ns(\"running_score\"), height = \"500px\")\n              ),\n              hr(),\n              DTOutput(ns(\"gsea_table\"))\n            ),\n            nav_panel(\n              \"Gene Networks\",\n              plotlyOutput(ns(\"gene_network\"), height = \"600px\"),\n              hr(),\n              p(\"Network visualization shows connections between genes in enriched pathways.\")\n            )\n          )\n        )\n      )\n    )\n  )\n}\n\n#' Pathway Visualization Module Server\nmod_pathway_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n\n    # Enrichment barplot\n    output$enrichment_plot <- renderPlotly({\n      req(shared_data$pathway_results)\n\n      df <- shared_data$pathway_results\n\n      # Ensure we have the required columns\n      if (!all(c(\"pathway\", \"p_value\") %in% names(df))) {\n        return(plot_ly() %>%\n          layout(\n            title = \"Pathway Enrichment\",\n            annotations = list(\n              text = \"No pathway data available\",\n              showarrow = FALSE,\n              xref = \"paper\", yref = \"paper\",\n              x = 0.5, y = 0.5\n            )\n          ))\n      }\n\n      # Get top 15 pathways\n      top_pathways <- df %>%\n        arrange(p_value) %>%\n        head(15) %>%\n        mutate(\n          neg_log_p = -log10(p_value),\n          pathway = factor(pathway, levels = rev(pathway))\n        )\n\n      p <- plot_ly(\n        data = top_pathways,\n        x = ~neg_log_p,\n        y = ~pathway,\n        type = 'bar',\n        orientation = 'h',\n        marker = list(\n          color = ~neg_log_p,\n          colorscale = list(\n            c(0, \"#E8F4F8\"),\n            c(1, \"#0066CC\")\n          ),\n          showscale = TRUE,\n          colorbar = list(title = \"-Log10(P)\")\n        ),\n        text = ~paste(\"Pathway:\", pathway,\n                     \"<br>P-value:\", format(p_value, digits = 3),\n                     if(\"gene_count\" %in% names(df))\n                       paste(\"<br>Genes:\", gene_count) else \"\"),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Top Enriched Pathways\",\n          xaxis = list(title = \"-Log10(P-value)\"),\n          yaxis = list(title = \"\", tickfont = list(size = 10)),\n          margin = list(l = 200)\n        )\n\n      p\n    })\n\n    # Dotplot\n    output$dotplot <- renderPlotly({\n      req(shared_data$pathway_results)\n\n      df <- shared_data$pathway_results\n\n      # Check required columns\n      if (!all(c(\"pathway\", \"p_value\") %in% names(df))) {\n        return(plot_ly() %>%\n          layout(\n            title = \"Pathway Dotplot\",\n            annotations = list(\n              text = \"Insufficient data for dotplot\",\n              showarrow = FALSE,\n              xref = \"paper\", yref = \"paper\",\n              x = 0.5, y = 0.5\n            )\n          ))\n      }\n\n      # Get top pathways\n      top_pathways <- df %>%\n        arrange(p_value) %>%\n        head(15)\n\n      # Add gene ratio if gene_count available\n      if (\"gene_count\" %in% names(top_pathways) && \"pathway_size\" %in% names(top_pathways)) {\n        top_pathways$gene_ratio <- top_pathways$gene_count / top_pathways$pathway_size\n      } else if (\"gene_count\" %in% names(top_pathways)) {\n        top_pathways$gene_ratio <- top_pathways$gene_count / 100  # Assume 100 genes per pathway\n      } else {\n        top_pathways$gene_ratio <- runif(nrow(top_pathways), 0.05, 0.3)\n      }\n\n      # Add q-value if not present\n      if (!\"q_value\" %in% names(top_pathways)) {\n        top_pathways$q_value <- p.adjust(top_pathways$p_value, method = \"BH\")\n      }\n\n      p <- plot_ly(\n        data = top_pathways,\n        x = ~gene_ratio,\n        y = ~reorder(pathway, -p_value),\n        type = 'scatter',\n        mode = 'markers',\n        marker = list(\n          size = ~if(\"gene_count\" %in% names(top_pathways)) gene_count * 2 else 10,\n          color = ~-log10(q_value),\n          colorscale = 'Reds',\n          showscale = TRUE,\n          colorbar = list(title = \"-Log10(Q)\")\n        ),\n        text = ~paste(\"Pathway:\", pathway,\n                     \"<br>Gene Ratio:\", round(gene_ratio, 3),\n                     \"<br>Q-value:\", format(q_value, digits = 3),\n                     if(\"gene_count\" %in% names(df))\n                       paste(\"<br>Gene Count:\", gene_count) else \"\"),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Pathway Enrichment Dotplot\",\n          xaxis = list(title = \"Gene Ratio\"),\n          yaxis = list(title = \"\", tickfont = list(size = 10)),\n          margin = list(l = 200)\n        )\n\n      p\n    })\n\n    # Pathway table\n    output$pathway_table <- renderDT({\n      req(shared_data$pathway_results)\n\n      df <- shared_data$pathway_results\n\n      # Round numeric columns\n      numeric_cols <- sapply(df, is.numeric)\n      df[numeric_cols] <- lapply(df[numeric_cols], function(x) {\n        if (all(x < 1, na.rm = TRUE)) {\n          format(x, digits = 3, scientific = TRUE)\n        } else {\n          round(x, 4)\n        }\n      })\n\n      datatable(\n        df,\n        options = list(\n          pageLength = 25,\n          scrollX = TRUE,\n          dom = 'Bfrtip',\n          buttons = c('copy', 'csv', 'excel')\n        ),\n        rownames = FALSE,\n        extensions = 'Buttons',\n        filter = 'top'\n      )\n    })\n\n    # GSEA plot\n    output$gsea_plot <- renderPlotly({\n      # Check if GSEA results exist\n      if (is.null(shared_data$pathway_results) ||\n          !any(c(\"NES\", \"gene_set\") %in% names(shared_data$pathway_results))) {\n\n        # Generate mock GSEA data\n        gsea_df <- data.frame(\n          gene_set = c(\"HALLMARK_MYC_TARGETS_V1\", \"HALLMARK_E2F_TARGETS\",\n                      \"HALLMARK_G2M_CHECKPOINT\", \"HALLMARK_APOPTOSIS\",\n                      \"HALLMARK_UNFOLDED_PROTEIN_RESPONSE\", \"HALLMARK_INFLAMMATORY_RESPONSE\",\n                      \"KEGG_PROTEASOME\", \"KEGG_CELL_CYCLE\",\n                      \"REACTOME_IMMUNE_SYSTEM\", \"GO_DNA_REPAIR\"),\n          NES = c(2.3, 2.1, 1.9, -1.8, 1.7, -1.6, 1.5, 1.4, -1.3, 1.2),\n          p_value = c(0.001, 0.002, 0.003, 0.004, 0.005, 0.01, 0.02, 0.03, 0.04, 0.05),\n          q_value = c(0.01, 0.01, 0.02, 0.02, 0.03, 0.05, 0.08, 0.1, 0.12, 0.15),\n          stringsAsFactors = FALSE\n        )\n      } else {\n        gsea_df <- shared_data$pathway_results\n      }\n\n      # Filter to significant gene sets\n      if (\"NES\" %in% names(gsea_df)) {\n        sig_sets <- gsea_df %>%\n          filter(q_value < 0.25) %>%\n          arrange(desc(abs(NES))) %>%\n          head(20)\n\n        # Color by direction\n        sig_sets$direction <- ifelse(sig_sets$NES > 0, \"Upregulated\", \"Downregulated\")\n\n        p <- plot_ly(\n          data = sig_sets,\n          x = ~NES,\n          y = ~reorder(gene_set, NES),\n          type = 'bar',\n          orientation = 'h',\n          marker = list(\n            color = ~ifelse(NES > 0, \"#DC3545\", \"#0066CC\")\n          ),\n          text = ~paste(\"Gene Set:\", gene_set,\n                       \"<br>NES:\", round(NES, 2),\n                       \"<br>Q-value:\", format(q_value, digits = 3)),\n          hovertemplate = \"%{text}<extra><\/extra>\"\n        ) %>%\n          layout(\n            title = \"GSEA - Normalized Enrichment Scores\",\n            xaxis = list(title = \"NES\", zeroline = TRUE),\n            yaxis = list(title = \"\", tickfont = list(size = 9)),\n            margin = list(l = 250),\n            shapes = list(\n              list(\n                type = 'line',\n                x0 = 0, x1 = 0,\n                y0 = -0.5, y1 = length(sig_sets$gene_set) - 0.5,\n                line = list(color = 'black', width = 1)\n              )\n            )\n          )\n      } else {\n        p <- plot_ly() %>%\n          layout(\n            title = \"GSEA Results\",\n            annotations = list(\n              text = \"No GSEA results available\",\n              showarrow = FALSE,\n              xref = \"paper\", yref = \"paper\",\n              x = 0.5, y = 0.5\n            )\n          )\n      }\n\n      p\n    })\n\n    # Running enrichment score plot\n    output$running_score <- renderPlotly({\n      # Create example running score plot\n      n_genes <- 1000\n      rank <- 1:n_genes\n\n      # Simulate hits for top gene set\n      hit_positions <- sort(sample(1:n_genes, 50))\n      running_score <- numeric(n_genes)\n\n      # Calculate running enrichment score\n      for (i in 1:n_genes) {\n        if (i %in% hit_positions) {\n          running_score[i] <- ifelse(i == 1, 0.02, running_score[i-1] + 0.02)\n        } else {\n          running_score[i] <- ifelse(i == 1, -0.001, running_score[i-1] - 0.001)\n        }\n      }\n\n      # Find peak\n      max_idx <- which.max(abs(running_score))\n\n      p <- plot_ly() %>%\n        add_trace(\n          x = rank,\n          y = running_score,\n          type = 'scatter',\n          mode = 'lines',\n          line = list(color = '#2E86AB', width = 2),\n          name = 'Running ES',\n          hovertemplate = \"Rank: %{x}<br>Score: %{y:.3f}<extra><\/extra>\"\n        ) %>%\n        add_trace(\n          x = hit_positions,\n          y = rep(min(running_score) - 0.05, length(hit_positions)),\n          type = 'scatter',\n          mode = 'markers',\n          marker = list(\n            symbol = 'line-ns',\n            size = 10,\n            color = 'black'\n          ),\n          name = 'Gene Hits',\n          hoverinfo = 'skip'\n        ) %>%\n        layout(\n          title = \"GSEA Running Enrichment Score\",\n          xaxis = list(title = \"Gene Rank\"),\n          yaxis = list(title = \"Enrichment Score\"),\n          shapes = list(\n            list(\n              type = 'line',\n              x0 = 0, x1 = n_genes,\n              y0 = 0, y1 = 0,\n              line = list(color = 'gray', dash = 'dash', width = 1)\n            ),\n            list(\n              type = 'line',\n              x0 = max_idx, x1 = max_idx,\n              y0 = 0, y1 = running_score[max_idx],\n              line = list(color = 'red', dash = 'dot', width = 2)\n            )\n          ),\n          annotations = list(\n            list(\n              x = max_idx,\n              y = running_score[max_idx],\n              text = paste(\"Peak ES:\", round(running_score[max_idx], 3)),\n              showarrow = TRUE,\n              arrowhead = 2,\n              arrowsize = 1,\n              arrowwidth = 2,\n              arrowcolor = 'red'\n            )\n          )\n        )\n\n      p\n    })\n\n    # GSEA table\n    output$gsea_table <- renderDT({\n      # Use pathway results or create mock GSEA data\n      if (!is.null(shared_data$pathway_results) &&\n          \"NES\" %in% names(shared_data$pathway_results)) {\n        df <- shared_data$pathway_results\n      } else {\n        df <- data.frame(\n          gene_set = c(\"HALLMARK_MYC_TARGETS_V1\", \"HALLMARK_E2F_TARGETS\",\n                      \"HALLMARK_G2M_CHECKPOINT\"),\n          NES = c(2.3, 2.1, 1.9),\n          p_value = c(0.001, 0.002, 0.003),\n          q_value = c(0.01, 0.01, 0.02),\n          leading_edge = c(\"MYC,CCND1,CDK4\", \"E2F1,RB1,CCND2\", \"CDK1,CCNB1,AURKA\"),\n          stringsAsFactors = FALSE\n        )\n      }\n\n      # Format numeric columns\n      numeric_cols <- sapply(df, is.numeric)\n      df[numeric_cols] <- lapply(df[numeric_cols], function(x) {\n        if (all(abs(x) < 1, na.rm = TRUE)) {\n          format(x, digits = 3, scientific = TRUE)\n        } else {\n          round(x, 3)\n        }\n      })\n\n      datatable(\n        df,\n        options = list(\n          pageLength = 25,\n          scrollX = TRUE,\n          dom = 'Bfrtip',\n          buttons = c('copy', 'csv', 'excel')\n        ),\n        rownames = FALSE,\n        extensions = 'Buttons'\n      )\n    })\n\n    # Gene network visualization\n    output$gene_network <- renderPlotly({\n      # Create a simple network for top pathways\n      if (!is.null(shared_data$pathway_results) &&\n          \"genes\" %in% names(shared_data$pathway_results)) {\n        # Get top 3 pathways\n        top_pathways <- shared_data$pathway_results %>%\n          arrange(p_value) %>%\n          head(3)\n\n        # Extract genes\n        all_genes <- character()\n        pathway_assignments <- list()\n\n        for (i in 1:nrow(top_pathways)) {\n          genes <- strsplit(as.character(top_pathways$genes[i]), \",\")[[1]]\n          all_genes <- c(all_genes, genes)\n          pathway_assignments[[top_pathways$pathway[i]]] <- genes\n        }\n\n        # Create nodes\n        unique_genes <- unique(all_genes)\n        n_genes <- length(unique_genes)\n\n        if (n_genes > 0) {\n          # Simple circular layout\n          angles <- seq(0, 2*pi, length.out = n_genes + 1)[1:n_genes]\n          x <- cos(angles)\n          y <- sin(angles)\n\n          # Color by pathway membership\n          node_colors <- rep(\"#CCCCCC\", n_genes)\n          colors <- c(\"#DC3545\", \"#0066CC\", \"#28A745\")\n\n          for (i in 1:length(pathway_assignments)) {\n            pathway_genes <- pathway_assignments[[i]]\n            gene_indices <- which(unique_genes %in% pathway_genes)\n            node_colors[gene_indices] <- colors[i]\n          }\n\n          p <- plot_ly(\n            x = x,\n            y = y,\n            type = 'scatter',\n            mode = 'markers+text',\n            text = unique_genes,\n            textposition = 'top center',\n            marker = list(\n              size = 15,\n              color = node_colors\n            ),\n            hovertemplate = \"Gene: %{text}<extra><\/extra>\"\n          ) %>%\n            layout(\n              title = \"Gene Network - Top 3 Pathways\",\n              xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE, title = \"\"),\n              yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE, title = \"\"),\n              showlegend = FALSE\n            )\n        } else {\n          p <- create_empty_network_plot()\n        }\n      } else {\n        p <- create_empty_network_plot()\n      }\n\n      p\n    })\n\n    # Helper function for empty network\n    create_empty_network_plot <- function() {\n      # Create example network\n      genes <- c(\"MYC\", \"CCND1\", \"CDK4\", \"BCL2\", \"TP53\", \"NFKB1\", \"STAT3\", \"IL6\")\n      n <- length(genes)\n\n      angles <- seq(0, 2*pi, length.out = n + 1)[1:n]\n      x <- cos(angles)\n      y <- sin(angles)\n\n      # Create some edges\n      edges <- data.frame(\n        x0 = c(x[1], x[1], x[2], x[3], x[5]),\n        y0 = c(y[1], y[1], y[2], y[3], y[5]),\n        x1 = c(x[2], x[3], x[4], x[5], x[6]),\n        y1 = c(y[2], y[3], y[4], y[5], y[6])\n      )\n\n      p <- plot_ly() %>%\n        # Add edges\n        add_segments(\n          data = edges,\n          x = ~x0, y = ~y0,\n          xend = ~x1, yend = ~y1,\n          line = list(color = '#CCCCCC', width = 1),\n          hoverinfo = 'skip'\n        ) %>%\n        # Add nodes\n        add_trace(\n          x = x,\n          y = y,\n          type = 'scatter',\n          mode = 'markers+text',\n          text = genes,\n          textposition = 'top center',\n          marker = list(\n            size = 20,\n            color = c(rep(\"#DC3545\", 3), rep(\"#0066CC\", 3), rep(\"#28A745\", 2))\n          ),\n          hovertemplate = \"Gene: %{text}<extra><\/extra>\"\n        ) %>%\n        layout(\n          title = \"Example Gene Network\",\n          xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE, title = \"\"),\n          yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE, title = \"\"),\n          showlegend = FALSE\n        )\n\n      p\n    }\n  })\n}","type":"text"},{"name":"modules/mod_qc_viz.R","content":"# modules/mod_qc_viz.R\n# Module for QC visualization\n\n#' QC Visualization Module UI\nmod_qc_viz_ui <- function(id) {\n  ns <- NS(id)\n\n  tagList(\n    layout_columns(\n      col_widths = c(12),\n\n      # QC metrics overview\n      card(\n        card_header(\"Quality Control Metrics\"),\n        card_body(\n          layout_columns(\n            col_widths = c(6, 6),\n            plotlyOutput(ns(\"library_size_plot\")),\n            plotlyOutput(ns(\"gene_detection_plot\"))\n          ),\n\n          hr(),\n\n          layout_columns(\n            col_widths = c(6, 6),\n            plotlyOutput(ns(\"pca_plot\")),\n            plotlyOutput(ns(\"outlier_plot\"))\n          ),\n\n          hr(),\n\n          h5(\"Sample QC Table\"),\n          DTOutput(ns(\"qc_table\"))\n        )\n      )\n    )\n  )\n}\n\n#' QC Visualization Module Server\nmod_qc_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n\n    # Library size distribution\n    output$library_size_plot <- renderPlotly({\n      req(shared_data$qc_metrics)\n\n      p <- plot_ly(\n        data = shared_data$qc_metrics,\n        x = ~sample,\n        y = ~total_counts,\n        type = 'bar',\n        marker = list(\n          color = ~total_counts,\n          colorscale = 'Blues',\n          showscale = FALSE\n        ),\n        text = ~paste(\"Sample:\", sample,\n                     \"<br>Total counts:\", format(total_counts, big.mark = \",\")),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Library Size Distribution\",\n          xaxis = list(title = \"Sample\", tickangle = -45),\n          yaxis = list(title = \"Total Counts\"),\n          margin = list(b = 100)\n        )\n\n      p\n    })\n\n    # Gene detection plot\n    output$gene_detection_plot <- renderPlotly({\n      req(shared_data$qc_metrics)\n\n      p <- plot_ly(\n        data = shared_data$qc_metrics,\n        y = ~detected_genes,\n        type = 'box',\n        name = \"Detected Genes\",\n        marker = list(color = \"#2E86AB\")\n      ) %>%\n        add_trace(\n          y = ~detected_genes,\n          type = 'scatter',\n          mode = 'markers',\n          name = \"Samples\",\n          marker = list(\n            color = \"#A23B72\",\n            size = 8\n          ),\n          text = ~paste(\"Sample:\", sample,\n                       \"<br>Detected genes:\", detected_genes),\n          hovertemplate = \"%{text}<extra><\/extra>\"\n        ) %>%\n        layout(\n          title = \"Gene Detection per Sample\",\n          yaxis = list(title = \"Number of Detected Genes\"),\n          showlegend = FALSE\n        )\n\n      p\n    })\n\n    # PCA plot\n    output$pca_plot <- renderPlotly({\n      req(shared_data$raw_data)\n\n      # Simple PCA for visualization\n      if (is.list(shared_data$raw_data) && \"counts\" %in% names(shared_data$raw_data)) {\n        counts <- shared_data$raw_data$counts\n\n        # Log transform and transpose\n        log_counts <- log2(counts + 1)\n        pca_result <- prcomp(t(log_counts), scale. = TRUE, center = TRUE)\n\n        # Get PC scores\n        pc_df <- data.frame(\n          sample = rownames(pca_result$x),\n          PC1 = pca_result$x[,1],\n          PC2 = pca_result$x[,2],\n          stringsAsFactors = FALSE\n        )\n\n        # Calculate variance explained\n        var_explained <- round(100 * pca_result$sdev^2 / sum(pca_result$sdev^2), 1)\n\n        p <- plot_ly(\n          data = pc_df,\n          x = ~PC1,\n          y = ~PC2,\n          type = 'scatter',\n          mode = 'markers+text',\n          text = ~sample,\n          textposition = \"top center\",\n          marker = list(\n            size = 12,\n            color = \"#2E86AB\"\n          ),\n          hovertemplate = paste(\"Sample: %{text}\",\n                               \"<br>PC1: %{x:.2f}\",\n                               \"<br>PC2: %{y:.2f}\",\n                               \"<extra><\/extra>\")\n        ) %>%\n          layout(\n            title = \"PCA of Samples\",\n            xaxis = list(title = paste0(\"PC1 (\", var_explained[1], \"% variance)\")),\n            yaxis = list(title = paste0(\"PC2 (\", var_explained[2], \"% variance)\"))\n          )\n      } else {\n        # Empty plot if no data\n        p <- plot_ly() %>%\n          layout(\n            title = \"PCA Plot\",\n            annotations = list(\n              text = \"No expression data available\",\n              showarrow = FALSE,\n              xref = \"paper\",\n              yref = \"paper\",\n              x = 0.5,\n              y = 0.5\n            )\n          )\n      }\n\n      p\n    })\n\n    # Outlier detection plot\n    output$outlier_plot <- renderPlotly({\n      req(shared_data$qc_metrics)\n\n      # Add outlier status if not present\n      if (!\"is_outlier\" %in% names(shared_data$qc_metrics)) {\n        shared_data$qc_metrics$is_outlier <- FALSE\n      }\n\n      # Color by outlier status\n      colors <- ifelse(shared_data$qc_metrics$is_outlier, \"#DC3545\", \"#28A745\")\n      status <- ifelse(shared_data$qc_metrics$is_outlier, \"Outlier\", \"Pass QC\")\n\n      p <- plot_ly(\n        data = shared_data$qc_metrics,\n        x = ~log10(total_counts),\n        y = ~detected_genes,\n        type = 'scatter',\n        mode = 'markers',\n        marker = list(\n          size = 10,\n          color = colors,\n          line = list(\n            color = 'black',\n            width = 1\n          )\n        ),\n        text = ~paste(\"Sample:\", sample,\n                     \"<br>Status:\", status,\n                     \"<br>Total counts:\", format(total_counts, big.mark = \",\"),\n                     \"<br>Detected genes:\", detected_genes),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Outlier Detection\",\n          xaxis = list(title = \"Log10(Total Counts)\"),\n          yaxis = list(title = \"Detected Genes\"),\n          shapes = list(\n            # Add reference lines for outlier thresholds\n            list(\n              type = 'line',\n              x0 = min(log10(shared_data$qc_metrics$total_counts)),\n              x1 = max(log10(shared_data$qc_metrics$total_counts)),\n              y0 = quantile(shared_data$qc_metrics$detected_genes, 0.05),\n              y1 = quantile(shared_data$qc_metrics$detected_genes, 0.05),\n              line = list(\n                color = 'red',\n                dash = 'dash',\n                width = 1\n              )\n            )\n          )\n        )\n\n      p\n    })\n\n    # QC metrics table\n    output$qc_table <- renderDT({\n      req(shared_data$qc_metrics)\n\n      # Add percentage columns if available\n      display_df <- shared_data$qc_metrics\n      if (\"total_counts\" %in% names(display_df)) {\n        display_df$total_counts <- format(display_df$total_counts, big.mark = \",\")\n      }\n\n      datatable(\n        display_df,\n        options = list(\n          pageLength = 10,\n          scrollX = TRUE,\n          dom = 'Bfrtip',\n          buttons = c('copy', 'csv', 'excel')\n        ),\n        rownames = FALSE,\n        extensions = 'Buttons'\n      ) %>%\n        formatStyle(\n          columns = \"is_outlier\",\n          backgroundColor = styleEqual(TRUE, \"#FFE5E5\"),\n          target = 'row'\n        )\n    })\n  })\n}","type":"text"},{"name":"modules/mod_survival_viz.R","content":"# modules/mod_survival_viz.R\n# Module for survival analysis visualization\n\n#' Survival Visualization Module UI\nmod_survival_viz_ui <- function(id) {\n  ns <- NS(id)\n\n  tagList(\n    layout_columns(\n      col_widths = c(3, 9),\n\n      # Left panel - Controls\n      card(\n        card_header(\"Survival Analysis Controls\"),\n        card_body(\n          radioButtons(\n            ns(\"survival_type\"),\n            \"Survival Endpoint:\",\n            choices = c(\"Overall Survival\" = \"os\",\n                       \"Progression-Free Survival\" = \"pfs\"),\n            selected = \"os\"\n          ),\n\n          selectInput(\n            ns(\"group_by\"),\n            \"Group By:\",\n            choices = c(\"Risk Group\" = \"risk_group\",\n                       \"ISS Stage\" = \"stage\",\n                       \"Response\" = \"response\",\n                       \"None\" = \"none\"),\n            selected = \"risk_group\"\n          ),\n\n          hr(),\n\n          h5(\"Cox Regression\"),\n          checkboxGroupInput(\n            ns(\"cox_covariates\"),\n            \"Select Covariates:\",\n            choices = c(\"Age\" = \"age\",\n                       \"Stage\" = \"stage\",\n                       \"Risk Group\" = \"risk_group\"),\n            selected = c(\"age\", \"stage\")\n          ),\n\n          actionButton(\n            ns(\"run_cox\"),\n            \"Run Cox Model\",\n            class = \"btn-primary\",\n            icon = icon(\"play\")\n          ),\n\n          hr(),\n\n          h5(\"Survival Summary\"),\n          tableOutput(ns(\"survival_summary\"))\n        )\n      ),\n\n      # Right panel - Visualizations\n      card(\n        card_header(\"Survival Analysis Results\"),\n        card_body(\n          navset_tab(\n            nav_panel(\n              \"Kaplan-Meier Plot\",\n              plotlyOutput(ns(\"km_plot\"), height = \"500px\"),\n              verbatimTextOutput(ns(\"km_stats\"))\n            ),\n            nav_panel(\n              \"Cox Regression\",\n              plotlyOutput(ns(\"forest_plot\"), height = \"400px\"),\n              hr(),\n              tableOutput(ns(\"cox_table\"))\n            ),\n            nav_panel(\n              \"Risk Table\",\n              DTOutput(ns(\"risk_table\"))\n            ),\n            nav_panel(\n              \"Survival Data\",\n              DTOutput(ns(\"survival_data_table\"))\n            )\n          )\n        )\n      )\n    )\n  )\n}\n\n#' Survival Visualization Module Server\nmod_survival_viz_server <- function(id, shared_data) {\n  moduleServer(id, function(input, output, session) {\n\n    # Reactive for Cox results\n    cox_results <- reactiveVal(NULL)\n\n    # Survival summary\n    output$survival_summary <- renderTable({\n      req(shared_data$survival_data)\n\n      surv_data <- shared_data$survival_data\n\n      # Select time and status columns\n      if (input$survival_type == \"os\") {\n        time_col <- if (\"os_time\" %in% names(surv_data)) \"os_time\" else \"time\"\n        status_col <- if (\"os_status\" %in% names(surv_data)) \"os_status\" else \"status\"\n      } else {\n        time_col <- if (\"pfs_time\" %in% names(surv_data)) \"pfs_time\" else \"time\"\n        status_col <- if (\"pfs_status\" %in% names(surv_data)) \"pfs_status\" else \"status\"\n      }\n\n      if (time_col %in% names(surv_data) && status_col %in% names(surv_data)) {\n        data.frame(\n          Metric = c(\"Total Patients\", \"Events\", \"Censored\",\n                    \"Median Follow-up\", \"1-Year Rate\"),\n          Value = c(\n            nrow(surv_data),\n            sum(surv_data[[status_col]], na.rm = TRUE),\n            sum(!surv_data[[status_col]], na.rm = TRUE),\n            round(median(surv_data[[time_col]], na.rm = TRUE), 1),\n            \"Calculated in plot\"\n          ),\n          stringsAsFactors = FALSE\n        )\n      } else {\n        data.frame(\n          Metric = \"No survival data\",\n          Value = \"Load data first\",\n          stringsAsFactors = FALSE\n        )\n      }\n    })\n\n    # Kaplan-Meier plot\n    output$km_plot <- renderPlotly({\n      req(shared_data$survival_data)\n\n      library(survival)\n\n      surv_data <- shared_data$survival_data\n\n      # Select appropriate columns\n      if (input$survival_type == \"os\") {\n        time_col <- if (\"os_time\" %in% names(surv_data)) \"os_time\" else \"time\"\n        status_col <- if (\"os_status\" %in% names(surv_data)) \"os_status\" else \"status\"\n        title_text <- \"Overall Survival\"\n      } else {\n        time_col <- if (\"pfs_time\" %in% names(surv_data)) \"pfs_time\" else \"time\"\n        status_col <- if (\"pfs_status\" %in% names(surv_data)) \"pfs_status\" else \"status\"\n        title_text <- \"Progression-Free Survival\"\n      }\n\n      # Check if columns exist\n      if (!time_col %in% names(surv_data) || !status_col %in% names(surv_data)) {\n        return(plot_ly() %>%\n          layout(\n            title = title_text,\n            annotations = list(\n              text = \"Survival data not available\",\n              showarrow = FALSE,\n              xref = \"paper\", yref = \"paper\",\n              x = 0.5, y = 0.5\n            )\n          ))\n      }\n\n      # Create survival object and fit\n      if (input$group_by != \"none\" && input$group_by %in% names(surv_data)) {\n        formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ \", input$group_by))\n        fit <- survfit(formula, data = surv_data)\n\n        # Get unique groups\n        groups <- unique(surv_data[[input$group_by]])\n        n_groups <- length(groups)\n\n        # Create plot data for each stratum\n        plot_list <- list()\n        colors <- c(\"#2E86AB\", \"#A23B72\", \"#F18F01\", \"#C73E1D\")\n\n        for (i in 1:n_groups) {\n          stratum_data <- data.frame(\n            time = fit$time[fit$strata == i],\n            surv = fit$surv[fit$strata == i],\n            upper = fit$upper[fit$strata == i],\n            lower = fit$lower[fit$strata == i],\n            n.risk = fit$n.risk[fit$strata == i],\n            n.event = fit$n.event[fit$strata == i]\n          )\n\n          # Add starting point\n          stratum_data <- rbind(\n            data.frame(time = 0, surv = 1, upper = 1, lower = 1,\n                      n.risk = fit$n[i], n.event = 0),\n            stratum_data\n          )\n\n          plot_list[[i]] <- list(\n            x = stratum_data$time,\n            y = stratum_data$surv,\n            name = as.character(groups[i]),\n            type = 'scatter',\n            mode = 'lines',\n            line = list(shape = 'hv', color = colors[i], width = 2),\n            hovertemplate = paste0(\n              \"Group: \", groups[i],\n              \"<br>Time: %{x:.0f}\",\n              \"<br>Survival: %{y:.2%}\",\n              \"<extra><\/extra>\"\n            )\n          )\n        }\n\n        p <- plot_ly() %>%\n          layout(\n            title = paste(title_text, \"by\", input$group_by),\n            xaxis = list(title = \"Time (days)\"),\n            yaxis = list(title = \"Survival Probability\", range = c(0, 1)),\n            hovermode = 'x unified'\n          )\n\n        for (trace in plot_list) {\n          p <- add_trace(p,\n            x = trace$x, y = trace$y,\n            name = trace$name,\n            type = trace$type,\n            mode = trace$mode,\n            line = trace$line,\n            hovertemplate = trace$hovertemplate\n          )\n        }\n\n      } else {\n        # Overall survival without groups\n        formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ 1\"))\n        fit <- survfit(formula, data = surv_data)\n\n        surv_df <- data.frame(\n          time = c(0, fit$time),\n          surv = c(1, fit$surv),\n          upper = c(1, fit$upper),\n          lower = c(1, fit$lower)\n        )\n\n        p <- plot_ly(\n          data = surv_df,\n          x = ~time,\n          y = ~surv,\n          type = 'scatter',\n          mode = 'lines',\n          line = list(shape = 'hv', color = '#2E86AB', width = 2),\n          name = 'Survival',\n          hovertemplate = \"Time: %{x:.0f}<br>Survival: %{y:.2%}<extra><\/extra>\"\n        ) %>%\n          add_ribbons(\n            y = ~upper,\n            ymin = ~lower,\n            line = list(color = 'transparent'),\n            fillcolor = 'rgba(46, 134, 171, 0.2)',\n            name = '95% CI',\n            showlegend = FALSE,\n            hoverinfo = 'skip'\n          ) %>%\n          layout(\n            title = title_text,\n            xaxis = list(title = \"Time (days)\"),\n            yaxis = list(title = \"Survival Probability\", range = c(0, 1))\n          )\n      }\n\n      p\n    })\n\n    # KM statistics\n    output$km_stats <- renderPrint({\n      req(shared_data$survival_data)\n\n      library(survival)\n\n      surv_data <- shared_data$survival_data\n\n      # Select appropriate columns\n      if (input$survival_type == \"os\") {\n        time_col <- if (\"os_time\" %in% names(surv_data)) \"os_time\" else \"time\"\n        status_col <- if (\"os_status\" %in% names(surv_data)) \"os_status\" else \"status\"\n      } else {\n        time_col <- if (\"pfs_time\" %in% names(surv_data)) \"pfs_time\" else \"time\"\n        status_col <- if (\"pfs_status\" %in% names(surv_data)) \"pfs_status\" else \"status\"\n      }\n\n      if (time_col %in% names(surv_data) && status_col %in% names(surv_data)) {\n        if (input$group_by != \"none\" && input$group_by %in% names(surv_data)) {\n          formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ \", input$group_by))\n\n          # Log-rank test\n          survdiff_result <- survdiff(formula, data = surv_data)\n          p_value <- 1 - pchisq(survdiff_result$chisq, length(survdiff_result$n) - 1)\n\n          cat(\"Log-rank test p-value:\", format(p_value, digits = 4), \"\\n\")\n\n          # Median survival by group\n          fit <- survfit(formula, data = surv_data)\n          print(fit)\n        } else {\n          formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ 1\"))\n          fit <- survfit(formula, data = surv_data)\n          print(fit)\n        }\n      } else {\n        cat(\"Survival data not available\")\n      }\n    })\n\n    # Run Cox regression\n    observeEvent(input$run_cox, {\n      req(shared_data$survival_data)\n      req(length(input$cox_covariates) > 0)\n\n      library(survival)\n      library(broom)\n\n      surv_data <- shared_data$survival_data\n\n      # Select appropriate columns\n      if (input$survival_type == \"os\") {\n        time_col <- if (\"os_time\" %in% names(surv_data)) \"os_time\" else \"time\"\n        status_col <- if (\"os_status\" %in% names(surv_data)) \"os_status\" else \"status\"\n      } else {\n        time_col <- if (\"pfs_time\" %in% names(surv_data)) \"pfs_time\" else \"time\"\n        status_col <- if (\"pfs_status\" %in% names(surv_data)) \"pfs_status\" else \"status\"\n      }\n\n      # Check which covariates are available\n      available_covars <- intersect(input$cox_covariates, names(surv_data))\n\n      if (length(available_covars) > 0 && time_col %in% names(surv_data)) {\n        # Create formula\n        formula <- as.formula(paste0(\n          \"Surv(\", time_col, \", \", status_col, \") ~ \",\n          paste(available_covars, collapse = \" + \")\n        ))\n\n        # Fit Cox model\n        cox_fit <- coxph(formula, data = surv_data)\n\n        # Store results\n        cox_results(tidy(cox_fit, exponentiate = TRUE, conf.int = TRUE))\n      }\n    })\n\n    # Forest plot for Cox regression\n    output$forest_plot <- renderPlotly({\n      req(cox_results())\n\n      df <- cox_results()\n\n      # Create forest plot\n      p <- plot_ly(\n        data = df,\n        x = ~estimate,\n        y = ~term,\n        type = 'scatter',\n        mode = 'markers',\n        marker = list(size = 10, color = '#2E86AB'),\n        error_x = list(\n          type = 'data',\n          symmetric = FALSE,\n          array = ~(conf.high - estimate),\n          arrayminus = ~(estimate - conf.low),\n          color = '#2E86AB'\n        ),\n        text = ~paste(\"Variable:\", term,\n                     \"<br>HR:\", round(estimate, 3),\n                     \"<br>95% CI:\", round(conf.low, 3), \"-\", round(conf.high, 3),\n                     \"<br>P-value:\", format(p.value, digits = 3)),\n        hovertemplate = \"%{text}<extra><\/extra>\"\n      ) %>%\n        layout(\n          title = \"Forest Plot - Hazard Ratios\",\n          xaxis = list(\n            title = \"Hazard Ratio (95% CI)\",\n            zeroline = FALSE,\n            type = 'log'\n          ),\n          yaxis = list(title = \"\"),\n          shapes = list(\n            list(\n              type = 'line',\n              x0 = 1, x1 = 1,\n              y0 = -0.5, y1 = length(df$term) - 0.5,\n              line = list(color = 'gray', dash = 'dash', width = 1)\n            )\n          )\n        )\n\n      p\n    })\n\n    # Cox regression table\n    output$cox_table <- renderTable({\n      req(cox_results())\n\n      df <- cox_results()\n\n      # Format for display\n      display_df <- data.frame(\n        Variable = df$term,\n        `Hazard Ratio` = round(df$estimate, 3),\n        `95% CI` = paste0(\"(\", round(df$conf.low, 3), \", \", round(df$conf.high, 3), \")\"),\n        `P-value` = format(df$p.value, digits = 3),\n        stringsAsFactors = FALSE\n      )\n\n      display_df\n    })\n\n    # Risk table\n    output$risk_table <- renderDT({\n      req(shared_data$survival_data)\n\n      library(survival)\n\n      surv_data <- shared_data$survival_data\n\n      # Select appropriate columns\n      if (input$survival_type == \"os\") {\n        time_col <- if (\"os_time\" %in% names(surv_data)) \"os_time\" else \"time\"\n        status_col <- if (\"os_status\" %in% names(surv_data)) \"os_status\" else \"status\"\n      } else {\n        time_col <- if (\"pfs_time\" %in% names(surv_data)) \"pfs_time\" else \"time\"\n        status_col <- if (\"pfs_status\" %in% names(surv_data)) \"pfs_status\" else \"status\"\n      }\n\n      if (time_col %in% names(surv_data) && status_col %in% names(surv_data)) {\n        # Create risk table at specific time points\n        time_points <- c(0, 365, 730, 1095, 1460)  # 0, 1, 2, 3, 4 years\n\n        if (input$group_by != \"none\" && input$group_by %in% names(surv_data)) {\n          formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ \", input$group_by))\n          fit <- summary(survfit(formula, data = surv_data), times = time_points)\n\n          risk_table <- data.frame(\n            Time = rep(time_points, length(fit$strata)),\n            Group = rep(names(fit$strata), each = length(time_points)),\n            `N at Risk` = fit$n.risk,\n            `N Events` = fit$n.event,\n            Survival = round(fit$surv, 3),\n            stringsAsFactors = FALSE\n          )\n        } else {\n          formula <- as.formula(paste0(\"Surv(\", time_col, \", \", status_col, \") ~ 1\"))\n          fit <- summary(survfit(formula, data = surv_data), times = time_points)\n\n          risk_table <- data.frame(\n            Time = time_points,\n            `N at Risk` = fit$n.risk,\n            `N Events` = fit$n.event,\n            Survival = round(fit$surv, 3),\n            stringsAsFactors = FALSE\n          )\n        }\n\n        datatable(\n          risk_table,\n          options = list(\n            pageLength = 10,\n            dom = 't'\n          ),\n          rownames = FALSE\n        )\n      } else {\n        datatable(data.frame(Message = \"No survival data available\"))\n      }\n    })\n\n    # Survival data table\n    output$survival_data_table <- renderDT({\n      req(shared_data$survival_data)\n\n      # Display first 100 rows\n      display_df <- head(shared_data$survival_data, 100)\n\n      # Round numeric columns\n      numeric_cols <- sapply(display_df, is.numeric)\n      display_df[numeric_cols] <- lapply(display_df[numeric_cols], function(x) round(x, 2))\n\n      datatable(\n        display_df,\n        options = list(\n          pageLength = 25,\n          scrollX = TRUE,\n          dom = 'Bfrtip',\n          buttons = c('copy', 'csv', 'excel')\n        ),\n        rownames = FALSE,\n        extensions = 'Buttons',\n        filter = 'top'\n      )\n    })\n  })\n}","type":"text"}]
